<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸ªäººä¸­å¿ƒ - ä¸šä½™çƒé˜Ÿç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/assets/app.css?v=20260130-1" />
  <style>
    body { margin: 0; min-height: 100vh; color: #e2e8f0; box-sizing: border-box;
      background: linear-gradient(180deg, rgba(0,8,24,.55) 0%, rgba(0,4,16,.72) 100%),
        url('/assets/profile-bg.png') no-repeat center center fixed;
      background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; }
    .glass, .profile-card { background: rgba(0,0,0,.18); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,.12); }
    .profile-card:hover { border-color: rgba(255,255,255,.16); }
    .profile-header { padding: 1.5rem 1.25rem; }
    /* å¤´åƒæ¡†å›ºå®šå°ºå¯¸ï¼Œä¸éšå›¾ç‰‡å˜åŒ– */
    .avatar-wrap { position: relative; display: inline-block; width: 5rem; height: 5rem; flex-shrink: 0; }
    .avatar-wrap .avatar-box { width: 5rem; height: 5rem; min-width: 5rem; min-height: 5rem; border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,.2); background: rgba(0,0,0,.2); display: flex; align-items: center; justify-content: center; }
    .avatar-wrap .avatar-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .avatar-wrap .edit-badge { position: absolute; right: 0; bottom: 0; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,.5); border: 2px solid rgba(255,255,255,.3); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #fff; pointer-events: none; }
    .status--success { color: #6ee7b7; }
    .status--error { color: #fca5a5; }
    /* è´¦å·åŒºï¼šé€€å‡ºç™»å½•ç”¨å±é™©æ ·å¼ï¼Œä¸ä¸»æ“ä½œåŒºåˆ† */
    .account-card { background: rgba(0,0,0,.18); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,.12); border-radius: 1rem; overflow: hidden; }
    /* ä¸Šä¼ æŒ‰é’®ï¼šä¸»æ“ä½œæ›´é†’ç›® */
  </style>
</head>
<body class="min-h-screen text-slate-100 safe-bottom">
  <div class="container mx-auto px-4 py-6 max-w-xl">

    <!-- é¡µé¢æ ‡é¢˜ -->
    <header class="mb-6">
      <h1 class="text-xl font-semibold text-white">ä¸ªäººä¸­å¿ƒ</h1>
      <p class="text-sm text-white/50 mt-0.5">ç®¡ç†ä½ çš„èµ„æ–™ä¸è´¦å·</p>
    </header>

    <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ï¼šå¤´åƒ + æ˜µç§° + é‚®ç®± -->
    <section class="glass rounded-2xl overflow-hidden mb-4">
      <div class="profile-header flex items-center gap-4">
        <div class="avatar-wrap">
          <div class="avatar-box">
            <img id="avatarImg" alt="å¤´åƒ" src="data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Crect%20width%3D%22128%22%20height%3D%22128%22%20rx%3D%2264%22%20fill%3D%22%23111827%22/%3E%3Ctext%20x%3D%2264%22%20y%3D%2276%22%20font-family%3D%22ui-sans-serif%2C%20system-ui%22%20font-size%3D%2248%22%20font-weight%3D%22800%22%20text-anchor%3D%22middle%22%20fill%3D%22rgba(255%2C255%2C255%2C0.85)%22%3E%3F%3C/text%3E%3C/svg%3E" />
          </div>
          <span class="edit-badge" aria-hidden="true">ğŸ“·</span>
        </div>
        <div class="min-w-0 flex-1">
          <div class="text-white font-semibold text-lg truncate" id="userTitle">æœªç™»å½•</div>
          <div class="text-white/60 text-sm truncate mt-0.5" id="userMeta">è¯·å…ˆç™»å½•</div>
        </div>
      </div>
    </section>

    <!-- å¤´åƒè®¾ç½®ï¼šç®€æ´ä¸€è¡Œé€‰æ‹© + ä¸Šä¼  -->
    <section class="glass rounded-2xl p-4 mb-4">
      <h2 class="text-white/80 text-sm font-medium mb-2">å¤´åƒè®¾ç½®</h2>
      <p class="text-white/50 text-xs mb-3">ç”¨äºæˆ˜æœ¯æ¿å±•ç¤ºã€‚</p>
      <div class="flex items-center gap-2 flex-wrap">
        <input id="fileInput" type="file" accept="image/*,image/heic,image/heif" class="flex-1 min-w-0 text-sm text-white/80 file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-medium file:bg-white/15 file:text-white hover:file:bg-white/20" />
        <button type="button" id="btnUpload" class="btn btn-primary shrink-0">â†‘ ä¸Šä¼ å¤´åƒ</button>
      </div>
      <span id="status" class="text-sm text-white/60 mt-2 block"></span>
    </section>

    <!-- ä¸Šåœºä½ç½®ï¼šç”¨æˆ·è‡ªé€‰å¸¸ç”¨ä½ç½®ï¼ˆå‚è€ƒè¶³çƒå¸¸è§ä½ç½®ï¼‰ -->
    <section class="glass rounded-2xl p-4 mb-4">
      <h2 class="text-white/80 text-sm font-medium mb-2">ä¸Šåœºä½ç½®</h2>
      <p class="text-white/50 text-xs mb-3">é€‰æ‹©ä½ å¸¸è¸¢çš„ä½ç½®ï¼Œä¾¿äºæ´»åŠ¨æŠ¥åä¸æˆ˜æœ¯å®‰æ’æ—¶å‚è€ƒã€‚</p>
      <div class="flex items-center gap-2 flex-wrap">
        <select id="playingPosition" class="flex-1 min-w-0 rounded-xl bg-black/30 border border-white/20 px-4 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
          <option value="">æœªé€‰æ‹©</option>
          <optgroup label="å®ˆé—¨å‘˜">
            <option value="å®ˆé—¨å‘˜">å®ˆé—¨å‘˜ (GK)</option>
          </optgroup>
          <optgroup label="åå«">
            <option value="ä¸­åå«">ä¸­åå« (CB)</option>
            <option value="å³åå«">å³åå« (RB)</option>
            <option value="å·¦åå«">å·¦åå« (LB)</option>
          </optgroup>
          <optgroup label="ä¸­åœº">
            <option value="åè…°">åè…° (DM)</option>
            <option value="ä¸­å‰å«">ä¸­å‰å« (CM)</option>
            <option value="å‰è…°">å‰è…° (AM)</option>
            <option value="å³å‰å«">å³å‰å« (RM)</option>
            <option value="å·¦å‰å«">å·¦å‰å« (LM)</option>
            <option value="å³è¾¹é”‹">å³è¾¹é”‹ (RW)</option>
            <option value="å·¦è¾¹é”‹">å·¦è¾¹é”‹ (LW)</option>
          </optgroup>
          <optgroup label="å‰é”‹">
            <option value="å½±é”‹">å½±é”‹ (SS)</option>
            <option value="ä¸­é”‹">ä¸­é”‹ (CF)</option>
            <option value="å‰é”‹">å‰é”‹ (ST)</option>
          </optgroup>
        </select>
        <button type="button" id="btnSavePosition" class="btn btn-primary shrink-0">ä¿å­˜</button>
      </div>
      <span id="positionStatus" class="text-sm text-white/60 mt-2 block"></span>
    </section>

    <!-- è´¦å·ï¼šé€€å‡ºç™»å½•ä½¿ç”¨å±é™©æ ·å¼ï¼Œä¸å¸¸è§„æ“ä½œåŒºåˆ† -->
    <section class="account-card mb-6">
      <div class="px-4 pt-4 pb-2">
        <h2 class="text-white/80 text-sm font-medium">è´¦å·</h2>
      </div>
      <div class="px-4 pb-4">
        <button type="button" id="btnLogout" class="btn btn-danger w-full">é€€å‡ºç™»å½•</button>
      </div>
    </section>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav" aria-label="åº•éƒ¨å¯¼èˆª">
    <div class="bottom-nav-inner">
      <a class="bottom-nav-item" data-nav="dashboard" href="/dashboard.html">é¦–é¡µ</a>
      <a class="bottom-nav-item" data-nav="tactics" href="/tactics.html">æˆ˜æœ¯æ¿</a>
      <a class="bottom-nav-item" data-nav="me" href="/profile.html">æˆ‘çš„</a>
    </div>
  </nav>

  <script src="/js/fancy-background.js?v=20260202-1"></script>
  <script>
    (function setBottomNavActive(){
      const path = window.location.pathname;
      const map = { '/dashboard.html': 'dashboard', '/tactics.html': 'tactics', '/profile.html': 'me' };
      const key = map[path] || 'me';
      document.querySelectorAll('.bottom-nav-item').forEach(a => {
        if (a.dataset.nav === key) a.classList.add('active');
      });
    })();

    const token = (localStorage.getItem('authToken') || sessionStorage.getItem('authToken'));
    const statusEl = document.getElementById('status');
    const avatarImg = document.getElementById('avatarImg');
    const userTitle = document.getElementById('userTitle');
    const userMeta = document.getElementById('userMeta');

    function setStatus(msg, type) {
      statusEl.textContent = msg || '';
      statusEl.classList.remove('status--success', 'status--error');
      if (type === 'success') statusEl.classList.add('status--success');
      if (type === 'error') statusEl.classList.add('status--error');
    }

    function requireLogin() {
      setStatus('æœªç™»å½•ï¼Œæ­£åœ¨è·³è½¬ç™»å½•é¡µâ€¦', 'error');
      setTimeout(() => (window.location.href = '/login.html'), 800);
    }

    const positionStatusEl = document.getElementById('positionStatus');
    const playingPositionEl = document.getElementById('playingPosition');
    const btnSavePosition = document.getElementById('btnSavePosition');

    function setPositionStatus(msg, type) {
      if (!positionStatusEl) return;
      positionStatusEl.textContent = msg || '';
      positionStatusEl.classList.remove('status--success', 'status--error');
      if (type === 'success') positionStatusEl.classList.add('status--success');
      if (type === 'error') positionStatusEl.classList.add('status--error');
    }

    async function loadMe() {
      if (!token) return requireLogin();
      try {
        const res = await fetch('/auth/me', { headers: { Authorization: 'Bearer ' + token } });
        if (!res.ok) return requireLogin();
        const me = await res.json();
        userTitle.textContent = me.username || 'ç”¨æˆ·';
        userMeta.textContent = me.email || '';
        if (me.avatarUrl) {
          var avatarSrc = me.avatarUrl.startsWith('http') ? me.avatarUrl : (window.location.origin + me.avatarUrl);
          avatarImg.src = avatarSrc + (avatarSrc.indexOf('?') >= 0 ? '&' : '?') + 't=' + Date.now();
        }
        if (playingPositionEl && me.playingPosition !== undefined) {
          playingPositionEl.value = me.playingPosition || '';
        }
      } catch (e) {
        setStatus('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
      }
    }

    let previewUrl = null;
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (previewUrl) URL.revokeObjectURL(previewUrl);
      previewUrl = URL.createObjectURL(f);
      avatarImg.src = previewUrl;
      setStatus('');
    });

    const MAX_AVATAR_SIZE = 10 * 1024 * 1024;
    document.getElementById('btnUpload').addEventListener('click', async () => {
      const btn = document.getElementById('btnUpload');
      const input = document.getElementById('fileInput');
      const f = input.files && input.files[0];
      if (!f) return setStatus('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'error');
      if (f.size > MAX_AVATAR_SIZE) return setStatus('å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 10MBï¼ˆå½“å‰çº¦ ' + (f.size / 1024 / 1024).toFixed(1) + 'MBï¼‰', 'error');
      if (!token) return requireLogin();

      btn.disabled = true;
      btn.classList.add('opacity-60');
      setStatus('ä¸Šä¼ ä¸­â€¦');

      const fd = new FormData();
      fd.append('file', f);

      try {
        const res = await fetch('/users/me/avatar', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token },
          body: fd,
        });

        if (res.status === 401 || res.status === 403) {
          setStatus('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', 'error');
          localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken');
          localStorage.removeItem('user');
          return setTimeout(() => (window.location.href = '/login.html'), 600);
        }

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = (data && (data.message || data.error)) ? (data.message || data.error) : 'HTTP ' + res.status;
          setStatus('ä¸Šä¼ å¤±è´¥ï¼š' + msg, 'error');
          return;
        }

        setStatus('ä¸Šä¼ æˆåŠŸ', 'success');
        if (data.avatarUrl) {
          avatarImg.src = data.avatarUrl + '?t=' + Date.now();
          const cached = JSON.parse(localStorage.getItem('user') || 'null');
          if (cached) { cached.avatarUrl = data.avatarUrl; localStorage.setItem('user', JSON.stringify(cached)); }
        }
      } catch (e) {
        setStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-60');
      }
    });

    if (btnSavePosition && playingPositionEl) {
      btnSavePosition.addEventListener('click', async () => {
        if (!token) return requireLogin();
        const value = (playingPositionEl.value || '').trim();
        btnSavePosition.disabled = true;
        setPositionStatus('ä¿å­˜ä¸­â€¦');
        try {
          const res = await fetch('/users/me', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer ' + token,
            },
            body: JSON.stringify({ playingPosition: value || '' }),
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok) {
            setPositionStatus('å·²ä¿å­˜', 'success');
            const cached = JSON.parse(localStorage.getItem('user') || 'null');
            if (cached) {
              cached.playingPosition = (data.playingPosition ?? value) || null;
              localStorage.setItem('user', JSON.stringify(cached));
            }
          } else {
            setPositionStatus((data.message || data.error) || 'ä¿å­˜å¤±è´¥', 'error');
          }
        } catch (e) {
          setPositionStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'error');
        } finally {
          btnSavePosition.disabled = false;
        }
      });
    }

    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    });

    loadMe();
  </script>
</body>
</html>
