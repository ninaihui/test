<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>个人中心 - 业余球队管理系统</title>
  <link rel="stylesheet" href="/assets/app.css?v=20260130-1" />
  <style>
    body { margin: 0; min-height: 100vh; color: #e2e8f0; box-sizing: border-box;
      background:
        radial-gradient(900px 480px at 20% 10%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(900px 480px at 85% 0%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(180deg, #070A12 0%, #0B1530 100%);
      background-attachment: fixed; }
    .glass, .profile-card { background: rgba(255,255,255,.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .profile-card:hover { border-color: rgba(255,255,255,.16); }

    /* 简约大气：主按钮统一胶囊 */
    .btn.btn-primary { border-radius: 999px; font-weight: 800; box-shadow: none !important; }
    .btn.btn-primary:hover { filter: brightness(1.02); }
    .btn.btn-primary:active { transform: translateY(0.5px); }
    .profile-header { padding: 1.5rem 1.25rem; }
    /* 头像框固定尺寸，不随图片变化 */
    .avatar-wrap { position: relative; display: inline-block; width: 5rem; height: 5rem; flex-shrink: 0; cursor: pointer; }
    .avatar-wrap .avatar-box { width: 5rem; height: 5rem; min-width: 5rem; min-height: 5rem; border-radius: 50%; overflow: hidden;
      border: 2px solid rgba(255,255,255,.18); background: rgba(255,255,255,.05);
      display: flex; align-items: center; justify-content: center; }
    .avatar-wrap .avatar-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .avatar-wrap .edit-badge { position: absolute; right: -2px; bottom: -2px; width: 30px; height: 30px; border-radius: 50%;
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.18);
      display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,.92); pointer-events: none;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .avatar-wrap .edit-badge svg { width: 16px; height: 16px; opacity: .95; }
    .status--success { color: #6ee7b7; }
    .status--error { color: #fca5a5; }
    /* 账号区：退出登录用危险样式，与主操作区分 */
    .account-card { background: rgba(255,255,255,.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.10); border-radius: 1rem; overflow: hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    /* 上传按钮：主操作更醒目 */
  </style>
</head>
<body class="min-h-screen text-slate-100 safe-bottom-nav">
  <!-- 登出按钮已移除 -->
  <div class="container mx-auto px-4 py-6 max-w-xl">

    <!-- 页面标题 -->
    <header class="mb-6">
      <h1 class="text-xl font-semibold text-white">个人中心</h1>
      <p class="text-sm text-white/50 mt-0.5">管理你的资料与账号</p>
    </header>

    <!-- 个人信息卡片：头像 + 昵称 + 邮箱（参考常见 App 个人中心） -->
    <section class="glass rounded-2xl overflow-hidden mb-4">
      <div class="profile-header flex items-center gap-4">
        <div class="avatar-wrap" role="button" tabindex="0" aria-label="点击更换头像">
          <div class="avatar-box">
            <img id="avatarImg" alt="头像" src="data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Crect%20width%3D%22128%22%20height%3D%22128%22%20rx%3D%2264%22%20fill%3D%22%23111827%22/%3E%3Ctext%20x%3D%2264%22%20y%3D%2276%22%20font-family%3D%22ui-sans-serif%2C%20system-ui%22%20font-size%3D%2248%22%20font-weight%3D%22800%22%20text-anchor%3D%22middle%22%20fill%3D%22rgba(255%2C255%2C255%2C0.85)%22%3E%3F%3C/text%3E%3C/svg%3E" />
          </div>
          <span class="edit-badge" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2-2h4l2 2h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="3"/>
            </svg>
          </span>
        </div>
        <div class="min-w-0 flex-1">
          <div class="text-white font-semibold text-lg truncate" id="userTitle">未登录</div>
          <div class="text-white/60 text-sm truncate mt-0.5" id="userMeta">请先登录</div>
          <div class="text-white/45 text-xs mt-1">点击头像更换</div>
        </div>
      </div>
    </section>

    <!-- 头像设置：点击头像选择；弹窗圆形预览并确认上传 -->
    <section class="glass rounded-2xl p-4 mb-4">
      <h2 class="text-white/80 text-sm font-medium mb-2">提示</h2>
      <p class="text-white/50 text-xs">点击上方头像即可选择并上传新头像（用于战术板展示）。</p>
      <input id="fileInput" type="file" accept="image/*,image/heic,image/heif" class="hidden" />
      <span id="status" class="text-sm text-white/60 mt-2 block"></span>
    </section>

    <!-- 头像裁剪弹窗（简易：居中裁剪为正方形，并用圆形框预览） -->
    <div id="avatarCropOverlay" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4">
      <div class="glass rounded-2xl w-full max-w-sm p-4 border border-white/15">
        <div class="flex items-center justify-between mb-3">
          <div class="text-white font-semibold">预览头像</div>
          <button type="button" id="btnCropClose" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/15 border border-white/15 flex items-center justify-center" aria-label="关闭">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="flex items-center justify-center">
          <div class="relative w-40 h-40 rounded-full overflow-hidden border-2 border-white/25 bg-black/20">
            <img id="avatarCropPreview" alt="头像预览" class="w-full h-full object-cover" />
          </div>
        </div>
        <p class="text-white/50 text-xs mt-3">将自动居中裁剪为正方形并上传（显示效果与战术板一致）。</p>
        <div class="flex items-center justify-end gap-2 mt-4">
          <button type="button" id="btnCropCancel" class="btn btn-ghost">取消</button>
          <button type="button" id="btnCropUpload" class="btn btn-primary">上传头像</button>
        </div>
      </div>
    </div>

    <!-- 上场位置：用户自选常用位置（参考足球常见位置） -->
    <section class="glass rounded-2xl p-4 mb-4">
      <h2 class="text-white/80 text-sm font-medium mb-2">上场位置</h2>
      <p class="text-white/50 text-xs mb-3">选择你常踢的位置，便于活动报名与战术安排时参考。</p>
      <div class="flex items-center gap-2 flex-wrap">
        <select id="playingPosition" class="flex-1 min-w-0 rounded-xl bg-black/30 border border-white/20 px-4 py-2.5 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
          <option value="">未选择</option>
          <optgroup label="守门员">
            <option value="守门员">守门员 (GK)</option>
          </optgroup>
          <optgroup label="后卫">
            <option value="中后卫">中后卫 (CB)</option>
            <option value="右后卫">右后卫 (RB)</option>
            <option value="左后卫">左后卫 (LB)</option>
          </optgroup>
          <optgroup label="中场">
            <option value="后腰">后腰 (DM)</option>
            <option value="中前卫">中前卫 (CM)</option>
            <option value="前腰">前腰 (AM)</option>
            <option value="右前卫">右前卫 (RM)</option>
            <option value="左前卫">左前卫 (LM)</option>
            <option value="右边锋">右边锋 (RW)</option>
            <option value="左边锋">左边锋 (LW)</option>
          </optgroup>
          <optgroup label="前锋">
            <option value="影锋">影锋 (SS)</option>
            <option value="中锋">中锋 (CF)</option>
            <option value="前锋">前锋 (ST)</option>
          </optgroup>
        </select>
        <button type="button" id="btnSavePosition" class="btn btn-primary shrink-0">保存</button>
      </div>
      <span id="positionStatus" class="text-sm text-white/60 mt-2 block"></span>
    </section>

    <!-- 账号：退出登录使用危险样式，与常规操作区分 -->
    <section class="account-card mb-6">
      <div class="px-4 pt-4 pb-2">
        <h2 class="text-white/80 text-sm font-medium">账号</h2>
      </div>
      <div class="px-4 pb-4">
        <button type="button" id="btnLogout" class="btn btn-danger w-full">退出登录</button>
      </div>
    </section>
  </div>

  <!-- 底部导航 -->
  <nav class="bottom-nav" aria-label="底部导航">
    <div class="bottom-nav-inner">
      <a class="bottom-nav-item" data-nav="dashboard" href="/dashboard.html">首页</a>
      <a class="bottom-nav-item" data-nav="activities" href="/activities.html">活动</a>
      <a class="bottom-nav-item" data-nav="me" href="/profile.html">我的</a>
    </div>
  </nav>

  <!-- fancy-background removed for minimalist UI -->
  <script>
    (function () {
      'use strict';
      var statusEl = document.getElementById('status');
      var avatarImg = document.getElementById('avatarImg');
      var userTitle = document.getElementById('userTitle');
      var userMeta = document.getElementById('userMeta');
      var fileInputEl = document.getElementById('fileInput');
      var btnUploadEl = document.getElementById('btnUpload'); // legacy (removed from UI)
      var avatarWrap = document.querySelector('.avatar-wrap');
      var btnSavePosition = document.getElementById('btnSavePosition');
      var playingPositionEl = document.getElementById('playingPosition');
      var positionStatusEl = document.getElementById('positionStatus');
      var btnLogoutEl = document.getElementById('btnLogout');

      if (!statusEl || !avatarImg || !userTitle || !userMeta) return;

      (function setBottomNavActive() {
        var path = window.location.pathname;
        var map = { '/dashboard.html': 'dashboard', '/activities.html': 'activities', '/profile.html': 'me' };
        var key = map[path] || 'me';
        document.querySelectorAll('.bottom-nav-item').forEach(function (a) {
          a.classList.remove('active');
          if (a.dataset.nav === key) a.classList.add('active');
        });
      })();

      function getToken() {
        return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
      }
      var defaultAvatarSrc = avatarImg.src;
      function toAbsoluteAvatarUrl(url) {
        if (!url) return '';
        if (url.indexOf('http://') === 0 || url.indexOf('https://') === 0) return url;
        var path = url.indexOf('/') === 0 ? url : '/' + url;
        return window.location.origin + path;
      }
      function setAvatarFromUrl(url) {
        if (!avatarImg) return;
        if (!url) { avatarImg.src = defaultAvatarSrc; return; }
        var src = toAbsoluteAvatarUrl(url);
        avatarImg.src = src + (src.indexOf('?') >= 0 ? '&' : '?') + 't=' + Date.now();
      }
      avatarImg.addEventListener('error', function () {
        if (avatarImg && avatarImg.src !== defaultAvatarSrc) avatarImg.src = defaultAvatarSrc;
      });

      function setStatus(msg, type) {
        if (!statusEl) return;
        statusEl.textContent = msg || '';
        statusEl.classList.remove('status--success', 'status--error');
        if (type === 'success') statusEl.classList.add('status--success');
        if (type === 'error') statusEl.classList.add('status--error');
      }
      function requireLogin() {
        setStatus('未登录，正在跳转登录页…', 'error');
        setTimeout(function () { window.location.href = window.location.origin + '/login.html'; }, 1200);
      }
      function setPositionStatus(msg, type) {
        if (!positionStatusEl) return;
        positionStatusEl.textContent = msg || '';
        positionStatusEl.classList.remove('status--success', 'status--error');
        if (type === 'success') positionStatusEl.classList.add('status--success');
        if (type === 'error') positionStatusEl.classList.add('status--error');
      }

      async function loadMe() {
        var t = getToken();
        if (!t) {
          setStatus('未登录。请用与首页相同的地址登录后再进个人中心（如都用 192.168.0.65:3000）', 'error');
          setTimeout(function () { requireLogin(); }, 100);
          return;
        }
        if (userTitle) userTitle.textContent = '加载中…';
        if (userMeta) userMeta.textContent = '';
        try {
          var res = await fetch('/auth/me', { headers: { Authorization: 'Bearer ' + t } });
          if (!res.ok) { requireLogin(); return; }
          var me = await res.json();
          if (userTitle) userTitle.textContent = me.username || '用户';
          if (userMeta) userMeta.textContent = me.email || '';
          setAvatarFromUrl(me.avatarUrl);
          try {
            var profileRes = await fetch('/users/me', { headers: { Authorization: 'Bearer ' + t } });
            if (profileRes.ok) {
              var profile = await profileRes.json();
              if (playingPositionEl && profile.playingPosition !== undefined) playingPositionEl.value = profile.playingPosition || '';
              if (profile.avatarUrl) setAvatarFromUrl(profile.avatarUrl);
            }
          } catch (err) {}
        } catch (e) {
          setStatus('加载用户信息失败', 'error');
          if (userTitle) userTitle.textContent = '未登录';
          if (userMeta) userMeta.textContent = '请先登录';
        }
      }

      function cropToSquareBlob(file, cb) {
        try {
          var img = new Image();
          img.onload = function () {
            try {
              var w = img.naturalWidth || img.width;
              var h = img.naturalHeight || img.height;
              var side = Math.min(w, h);
              var sx = Math.floor((w - side) / 2);
              var sy = Math.floor((h - side) / 2);
              var canvas = document.createElement('canvas');
              canvas.width = 512;
              canvas.height = 512;
              var ctx = canvas.getContext('2d');
              ctx.imageSmoothingEnabled = true;
              ctx.imageSmoothingQuality = 'high';
              ctx.drawImage(img, sx, sy, side, side, 0, 0, 512, 512);
              canvas.toBlob(function (blob) { cb(blob); }, 'image/jpeg', 0.9);
            } catch (e) { cb(null); }
          };
          img.onerror = function () { cb(null); };
          img.src = URL.createObjectURL(file);
        } catch (e) { cb(null); }
      }

      function uploadAvatarBlob(blob) {
        if (!blob) { setStatus('裁剪失败，请换一张图', 'error'); return; }
        if (!getToken()) { setStatus('请先登录', 'error'); requireLogin(); return; }
        setStatus('上传中…');
        var fd = new FormData();
        fd.append('file', blob, 'avatar.jpg');
        fetch('/users/me/avatar', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + getToken() },
          body: fd,
        }).then(function (r) {
          if (r.status === 401 || r.status === 403) {
            setStatus('登录已失效，请重新登录', 'error');
            localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken');
            localStorage.removeItem('user');
            setTimeout(function () { window.location.href = window.location.origin + '/login.html'; }, 600);
            return { _authFail: true };
          }
          return r.json().then(function (data) { return { ok: r.ok, data: data }; });
        }).then(function (result) {
          if (!result || result._authFail) return;
          var data = result.data;
          if (result.ok && data && data.avatarUrl) {
            setStatus('上传成功', 'success');
            setAvatarFromUrl(data.avatarUrl);
            var cached = JSON.parse(localStorage.getItem('user') || 'null');
            if (cached) { cached.avatarUrl = data.avatarUrl; localStorage.setItem('user', JSON.stringify(cached)); }
          } else if (data && (data.message || data.error)) {
            setStatus('上传失败：' + (data.message || data.error), 'error');
          } else {
            setStatus('上传失败', 'error');
          }
        }).catch(function () {
          setStatus('网络错误，请稍后再试', 'error');
        }).finally(function () {
          if (fileInputEl) fileInputEl.value = '';
        });
      }

      var previewUrl = null;
      var cropOverlay = document.getElementById('avatarCropOverlay');
      var cropPreview = document.getElementById('avatarCropPreview');
      var btnCropClose = document.getElementById('btnCropClose');
      var btnCropCancel = document.getElementById('btnCropCancel');
      var btnCropUpload = document.getElementById('btnCropUpload');
      var pendingFile = null;

      function openCropModal(file) {
        pendingFile = file;
        try {
          if (previewUrl) URL.revokeObjectURL(previewUrl);
          previewUrl = URL.createObjectURL(file);
          if (cropPreview) cropPreview.src = previewUrl;
        } catch (e) {}
        if (cropOverlay) {
          cropOverlay.classList.remove('hidden');
          cropOverlay.classList.add('flex');
        }
      }
      function closeCropModal() {
        pendingFile = null;
        if (cropOverlay) {
          cropOverlay.classList.add('hidden');
          cropOverlay.classList.remove('flex');
        }
      }
      if (btnCropClose) btnCropClose.addEventListener('click', closeCropModal);
      if (btnCropCancel) btnCropCancel.addEventListener('click', closeCropModal);
      if (cropOverlay) cropOverlay.addEventListener('click', function (e) { if (e.target === cropOverlay) closeCropModal(); });

      if (btnCropUpload) {
        btnCropUpload.addEventListener('click', function () {
          if (!pendingFile) return;
          btnCropUpload.disabled = true;
          cropToSquareBlob(pendingFile, function (blob) {
            btnCropUpload.disabled = false;
            closeCropModal();
            uploadAvatarBlob(blob);
          });
        });
      }

      function openFilePicker() {
        if (!getToken()) { setStatus('请先登录', 'error'); requireLogin(); return; }
        if (fileInputEl) fileInputEl.click();
      }

      if (avatarWrap && fileInputEl) {
        avatarWrap.addEventListener('click', openFilePicker);
        avatarWrap.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openFilePicker();
          }
        });
      }

      if (fileInputEl) {
        fileInputEl.addEventListener('change', function (e) {
          var f = e.target.files && e.target.files[0];
          if (!f) return;
          // show preview in circle frame (matches actual avatar shape)
          setStatus('');
          openCropModal(f);
        });
      }

      if (btnSavePosition && playingPositionEl) {
        btnSavePosition.addEventListener('click', function () {
          if (!getToken()) { setStatus('请先登录', 'error'); requireLogin(); return; }
          var value = (playingPositionEl.value || '').trim();
          btnSavePosition.disabled = true;
          setPositionStatus('保存中…');
          fetch('/users/me', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer ' + getToken(),
            },
            body: JSON.stringify({ playingPosition: value || '' }),
          }).then(function (r) { return r.json().catch(function () { return {}; }); }).then(function (data) {
            if (data && data.playingPosition !== undefined) {
              setPositionStatus('已保存', 'success');
              var cached = JSON.parse(localStorage.getItem('user') || 'null');
              if (cached) { cached.playingPosition = data.playingPosition; localStorage.setItem('user', JSON.stringify(cached)); }
              setTimeout(function () { setPositionStatus('', ''); }, 3000);
            } else {
              setPositionStatus((data && (data.message || data.error)) || '保存失败', 'error');
            }
          }).catch(function () {
            setPositionStatus('网络错误，请稍后再试', 'error');
          }).then(function () {
            btnSavePosition.disabled = false;
          });
        });
      }

      if (btnLogoutEl) {
        function doLogout() {
          localStorage.removeItem('authToken');
          sessionStorage.removeItem('authToken');
          localStorage.removeItem('user');
          window.location.href = window.location.origin + '/login.html';
        }
        btnLogoutEl.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          doLogout();
        });
        btnLogoutEl.addEventListener('touchend', function (e) {
          e.preventDefault();
          doLogout();
        });
      }

      loadMe();
    })();
  </script>
</body>
</html>
