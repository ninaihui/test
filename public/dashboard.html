<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¦–é¡µ - ä¸šä½™çƒé˜Ÿç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/assets/app.css?v=20260130-1" />
  <style>
    body { margin: 0; min-height: 100vh; color: #e2e8f0; box-sizing: border-box;
      background: linear-gradient(180deg, rgba(0,8,24,.55) 0%, rgba(0,4,16,.72) 100%),
        url('/assets/login-bg.png') no-repeat center center fixed;
      background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; }
    .card, .glass { background: rgba(0,0,0,.18); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,.12); }
    .card-hover:hover { background: rgba(0,0,0,.28); border-color: rgba(255,255,255,.18); }
    .stat-num { font-variant-numeric: tabular-nums; }
    /* æ¬¢è¿åŒº */
    .welcome-card { padding: 1rem 1.25rem; }
    .welcome-card a { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.75rem; }
    .welcome-card a:hover { opacity: 0.95; }
    /* ä¸‹ä¸€åœºæ´»åŠ¨ä¸»å¡ç‰‡ï¼šæœ‰æ´»åŠ¨æ—¶å¯ç‚¹å‡»è¿›å…¥è¯¦æƒ… */
    .next-card { padding: 1.25rem; }
    #weekendCard[data-activity-id] { cursor: pointer; }
    .next-card .venue-row { color: rgba(255,255,255,.7); font-size: 0.875rem; margin-top: 0.25rem; }
    .next-card .time-row { color: rgba(255,255,255,.5); font-size: 0.8125rem; margin-top: 0.25rem; }
    .next-card .cta { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,.1); display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; }
    .badge-today { background: rgba(34,197,94,.25); color: #86efac; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    .badge-tomorrow { background: rgba(59,130,246,.25); color: #93c5fd; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    .badge-date { background: rgba(255,255,255,.1); color: rgba(255,255,255,.7); padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    /* ä¸‹ä¸€åœºæ´»åŠ¨ - æŠ¥åé˜Ÿå‘˜é¢„è§ˆ */
    .next-card .roster-label { font-size: 0.75rem; color: rgba(255,255,255,.5); margin-top: 0.75rem; margin-bottom: 0.25rem; }
    .next-card .roster-names { font-size: 0.8125rem; color: rgba(255,255,255,.75); line-height: 1.4; }
    .next-card .roster-names .name-tag { display: inline-block; margin: 0.125rem 0.25rem 0.125rem 0; padding: 0.125rem 0.5rem; background: rgba(255,255,255,.08); border-radius: 0.5rem; }
    /* æ´»åŠ¨åˆ—è¡¨é¡¹ */
    .activity-row { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,.08); text-decoration: none; color: inherit; transition: background .15s; }
    .activity-row:last-child { border-bottom: none; }
    .activity-row:hover { background: rgba(255,255,255,.05); }
    .activity-row .badge { flex-shrink: 0; min-width: 3rem; text-align: center; }
    .activity-row .body { flex: 1; min-width: 0; }
    .activity-row .body .name { font-weight: 500; color: #fff; }
    .activity-row .body .meta { font-size: 0.8125rem; color: rgba(255,255,255,.5); margin-top: 0.125rem; }
    .activity-row .arrow { color: rgba(255,255,255,.35); font-size: 0.875rem; flex-shrink: 0; }
    /* æ¬¢è¿åŒºå¤´åƒï¼šä¸ã€Œæˆ‘çš„ã€é¡µé¢ä¸€è‡´ 5rem Ã— 5rem */
    .welcome-avatar { width: 5rem; height: 5rem; min-width: 5rem; min-height: 5rem; border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,.2); background: rgba(0,0,0,.2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .welcome-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="min-h-screen safe-bottom pb-24">
    <div class="max-w-2xl mx-auto px-4 py-6">

      <!-- æ¬¢è¿åŒºï¼šå¤´åƒ + é—®å€™ + å‰¯æ ‡é¢˜ -->
      <section class="mb-6">
        <a href="/profile.html" class="card rounded-2xl welcome-card card-hover transition block">
          <div class="flex items-center gap-3">
            <div class="welcome-avatar">
              <img id="avatar" alt="å¤´åƒ" />
            </div>
            <div class="min-w-0 flex-1">
              <div id="greeting" class="text-white/70 text-sm">åŠ è½½ä¸­â€¦</div>
              <div id="userName" class="text-white font-semibold truncate text-lg">â€”</div>
              <div class="text-white/50 text-xs mt-0.5">ç‚¹å‡»è¿›å…¥ä¸ªäººä¸­å¿ƒ</div>
            </div>
            <span class="text-white/40 text-xl shrink-0" aria-hidden="true">â†’</span>
          </div>
        </a>
      </section>

      <!-- ä¸‹ä¸€åœºæ´»åŠ¨ï¼ˆä¸»å¡ç‰‡ï¼‰ -->
      <section class="mb-6" id="weekendSection">
        <h2 class="text-white/80 text-sm font-medium mb-3">ä¸‹ä¸€åœºæ´»åŠ¨</h2>
        <div id="weekendCard" class="card rounded-2xl next-card">
          <div id="weekendEmpty" class="text-white/50 text-sm text-center py-6">
            æš‚æ— å³å°†ä¸¾è¡Œçš„æ´»åŠ¨<br />
            <a href="/activities.html" class="text-cyan-400/90 text-xs mt-2 inline-block underline">å»æ´»åŠ¨é¡µçœ‹çœ‹</a>
          </div>
          <div id="weekendContent" class="hidden">
            <div id="weekendName" class="text-white font-semibold text-lg">â€”</div>
            <div id="weekendVenue" class="venue-row">â€”</div>
            <div id="weekendTime" class="time-row">â€”</div>
            <div id="weekendRoster" class="hidden">
              <div class="roster-label">å·²æŠ¥åé˜Ÿå‘˜</div>
              <div id="weekendRosterNames" class="roster-names"></div>
            </div>
            <div class="cta">
              <span id="weekendStatus" class="text-white/60 text-sm">â€”</span>
              <button type="button" id="weekendRegisterBtn" class="btn btn-primary hidden">æŠ¥å</button>
            </div>
          </div>
        </div>
      </section>

      <!-- å…¨éƒ¨æ´»åŠ¨ï¼ˆå·²åˆ›å»ºçš„æ‰€æœ‰æ´»åŠ¨ï¼‰ -->
      <section class="mb-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-white/80 text-sm font-medium">å…¨éƒ¨æ´»åŠ¨</h2>
          <a href="/activities.html" class="text-cyan-400/90 text-xs hover:underline">æ´»åŠ¨é¡µ</a>
        </div>
        <div id="activitiesList" class="card rounded-2xl overflow-hidden">
          <div id="activitiesEmpty" class="text-white/50 text-sm text-center py-6 px-4">
            æš‚æ— æ´»åŠ¨<br />
            <a href="/activities.html" class="text-cyan-400/90 text-xs mt-2 inline-block underline">å»æ´»åŠ¨é¡µ</a>
          </div>
          <div id="activityItems" class="hidden">
            <!-- ç”± JS å¡«å…… -->
          </div>
        </div>
      </section>

      <!-- æœåŠ¡çŠ¶æ€ï¼ˆå¼±åŒ–ï¼‰ -->
      <div class="text-white/35 text-xs flex items-center gap-2 pt-2">
        <span id="healthText">æ£€æŸ¥ä¸­â€¦</span>
        <span id="healthTime"></span>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav" aria-label="åº•éƒ¨å¯¼èˆª">
    <div class="bottom-nav-inner">
      <a class="bottom-nav-item active" data-nav="dashboard" href="/dashboard.html">é¦–é¡µ</a>
      <a class="bottom-nav-item" data-nav="tactics" href="/tactics.html">æˆ˜æœ¯æ¿</a>
      <a class="bottom-nav-item" data-nav="me" href="/profile.html">æˆ‘çš„</a>
    </div>
  </nav>

  <script src="/js/fancy-background.js"></script>
  <script>
(function () {
  const TOKEN_KEY = 'authToken';
  const USER_KEY = 'user';

  function escapeHtml(s) {
    if (s == null) return '';
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  var token = null;
  const avatarEl = document.getElementById('avatar');
  const greetingEl = document.getElementById('greeting');
  const nameEl = document.getElementById('userName');

  const defaultAvatar = 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Crect%20width%3D%22128%22%20height%3D%22128%22%20rx%3D%2264%22%20fill%3D%22%230b1220%22/%3E%3Ctext%20x%3D%2264%22%20y%3D%2276%22%20font-family%3D%22ui-sans-serif%2C%20system-ui%22%20font-size%3D%2246%22%20font-weight%3D%22800%22%20text-anchor%3D%22middle%22%20fill%3D%22rgba(255%2C255%2C255%2C0.85)%22%3E%3F%3C/text%3E%3C/svg%3E';

  function requireLogin(reason) {
    // #region agent log
    (function(d){fetch('http://127.0.0.1:7242/ingest/f9c175ba-04d6-464f-bb6b-0d5e0ace1822',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(function(){});})({location:'dashboard.html:requireLogin',message:'redirecting to login',data:{reason:reason||'',origin:window.location.origin},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H4,H5'});
    // #endregion
    console.warn('é¦–é¡µï¼šè·³è½¬ç™»å½•é¡µ â€”', reason || 'æœªç™»å½•æˆ–ç™»å½•å·²å¤±æ•ˆ');
    window.location.href = window.location.origin + '/login.html';
  }

  function setGreeting(username) {
    const hour = new Date().getHours();
    let timeLabel = 'ä½ å¥½';
    if (hour >= 5 && hour < 12) timeLabel = 'æ—©ä¸Šå¥½';
    else if (hour >= 12 && hour < 18) timeLabel = 'ä¸‹åˆå¥½';
    else if (hour >= 18) timeLabel = 'æ™šä¸Šå¥½';
    greetingEl.textContent = timeLabel + 'ï¼Œ';
    nameEl.textContent = username || 'ç”¨æˆ·';
  }

  async function loadMe() {
    var t = token || localStorage.getItem(TOKEN_KEY) || sessionStorage.getItem(TOKEN_KEY);
    if (!t) {
      requireLogin('æ—  token');
      return;
    }
    try {
      const res = await fetch('/auth/me', { headers: { Authorization: 'Bearer ' + t } });
      // #region agent log
      (function(d){fetch('http://127.0.0.1:7242/ingest/f9c175ba-04d6-464f-bb6b-0d5e0ace1822',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(function(){});})({location:'dashboard.html:loadMe',message:'/auth/me response',data:{status:res.status,ok:res.ok},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H5'});
      // #endregion
      if (!res.ok) {
        console.warn('é¦–é¡µï¼š/auth/me è¿”å›', res.status);
        requireLogin('/auth/me è¿”å› ' + res.status);
        return;
      }
      const me = await res.json();
      setGreeting(me.username);
      avatarEl.src = (me.avatarUrl ? (me.avatarUrl + '?t=' + Date.now()) : defaultAvatar);
      localStorage.setItem(USER_KEY, JSON.stringify(me));
    } catch (e) {
      console.warn('é¦–é¡µï¼š/auth/me è¯·æ±‚å¤±è´¥', e);
      requireLogin('è¯·æ±‚ /auth/me å¤±è´¥');
    }
  }

  function formatActivityDate(iso) {
    if (!iso) return 'â€”';
    const d = new Date(iso);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    d.setHours(0, 0, 0, 0);
    if (d.getTime() === today.getTime()) return 'ä»Šå¤© ' + new Date(iso).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    if (d.getTime() === tomorrow.getTime()) return 'æ˜å¤© ' + new Date(iso).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    return new Date(iso).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function getDateBadge(iso) {
    if (!iso) return { text: 'â€”', cls: 'badge-date' };
    const d = new Date(iso);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    d.setHours(0, 0, 0, 0);
    if (d.getTime() === today.getTime()) return { text: 'ä»Šå¤©', cls: 'badge-today' };
    if (d.getTime() === tomorrow.getTime()) return { text: 'æ˜å¤©', cls: 'badge-tomorrow' };
    const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
    return { text: d.getMonth() + 1 + '/' + d.getDate() + ' å‘¨' + week, cls: 'badge-date' };
  }

  function getVenueDisplay(activity) {
    if (activity.venue && activity.venue.name) return activity.venue.name;
    return activity.location || 'â€”';
  }

  async function loadWeekendActivity() {
    const emptyEl = document.getElementById('weekendEmpty');
    const contentEl = document.getElementById('weekendContent');
    const nameEl = document.getElementById('weekendName');
    const venueEl = document.getElementById('weekendVenue');
    const timeEl = document.getElementById('weekendTime');
    const statusEl = document.getElementById('weekendStatus');
    const btnEl = document.getElementById('weekendRegisterBtn');

    try {
      const res = await fetch('/activities?upcoming=1', { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return;
      const activities = await res.json();
      const list = Array.isArray(activities) ? activities : [];
      const first = list[0];
      if (!first || !first.id) {
        var cardEl = document.getElementById('weekendCard');
        if (cardEl) delete cardEl.dataset.activityId;
        emptyEl.hidden = false;
        contentEl.hidden = true;
        emptyEl.classList.remove('hidden');
        contentEl.classList.add('hidden');
        return;
      }
      const detailRes = await fetch('/activities/' + first.id, { headers: { Authorization: 'Bearer ' + token } });
      if (!detailRes.ok) {
        var cardEl = document.getElementById('weekendCard');
        if (cardEl) delete cardEl.dataset.activityId;
        emptyEl.hidden = false;
        contentEl.hidden = true;
        emptyEl.classList.remove('hidden');
        contentEl.classList.add('hidden');
        return;
      }
      const activity = await detailRes.json();
      const userStr = localStorage.getItem(USER_KEY);
      const me = userStr ? JSON.parse(userStr) : null;
      const myAtt = (activity.attendances || []).find(a => a.user && a.user.id === (me && me.id));
      const venueDisplay = getVenueDisplay(activity);

      emptyEl.hidden = true;
      contentEl.hidden = false;
      emptyEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
      var weekendCard = document.getElementById('weekendCard');
      if (weekendCard) weekendCard.dataset.activityId = activity.id;
      nameEl.textContent = activity.name || 'æœªå‘½åæ´»åŠ¨';
      venueEl.textContent = 'ğŸ“ ' + venueDisplay;
      timeEl.textContent = 'ğŸ• ' + formatActivityDate(activity.date);

      var rosterWrap = document.getElementById('weekendRoster');
      var rosterNamesEl = document.getElementById('weekendRosterNames');
      var attendances = activity.attendances || [];
      if (rosterWrap && rosterNamesEl) {
        if (attendances.length > 0) {
          rosterWrap.classList.remove('hidden');
          rosterNamesEl.innerHTML = attendances.map(function (a) {
            var name = (a.user && a.user.username) ? a.user.username : 'â€”';
            return '<span class="name-tag">' + escapeHtml(name) + '</span>';
          }).join('');
        } else {
          rosterWrap.classList.add('hidden');
          rosterNamesEl.innerHTML = '';
        }
      }

      if (myAtt) {
        statusEl.textContent = (myAtt.position && myAtt.position.trim()) ? 'å·²æŠ¥å Â· ' + myAtt.position : 'å·²æŠ¥å';
        statusEl.classList.remove('hidden');
        btnEl.classList.remove('hidden');
        btnEl.textContent = 'å–æ¶ˆæŠ¥å';
        btnEl.onclick = async (e) => {
          e.preventDefault();
          if (!confirm('ç¡®å®šå–æ¶ˆæŠ¥åï¼Ÿ')) return;
          btnEl.disabled = true;
          try {
            const r = await fetch('/activities/' + activity.id + '/register', {
              method: 'DELETE',
              headers: { Authorization: 'Bearer ' + token },
            });
            if (r.ok) loadWeekendActivity();
            else {
              const err = await r.json().catch(() => ({}));
              alert(err.message || 'å–æ¶ˆå¤±è´¥');
            }
          } finally {
            btnEl.disabled = false;
          }
        };
      } else {
        statusEl.classList.add('hidden');
        btnEl.classList.remove('hidden');
        btnEl.textContent = 'æŠ¥å';
        btnEl.onclick = async (e) => {
          e.preventDefault();
          btnEl.disabled = true;
          try {
            const r = await fetch('/activities/' + activity.id + '/register', {
              method: 'POST',
              headers: { Authorization: 'Bearer ' + token },
            });
            if (r.ok) loadWeekendActivity();
            else {
              const err = await r.json().catch(() => ({}));
              alert(err.message || 'æŠ¥åå¤±è´¥');
            }
          } finally {
            btnEl.disabled = false;
          }
        };
      }
    } catch (e) {
      emptyEl.hidden = false;
      contentEl.hidden = true;
      emptyEl.classList.remove('hidden');
      contentEl.classList.add('hidden');
    }
  }

  async function loadAllActivities() {
    const emptyEl = document.getElementById('activitiesEmpty');
    const itemsEl = document.getElementById('activityItems');

    try {
      const res = await fetch('/activities', { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return;
      const activities = await res.json();
      const list = Array.isArray(activities) ? activities : [];

      emptyEl.classList.toggle('hidden', list.length > 0);
      itemsEl.classList.toggle('hidden', list.length === 0);
      itemsEl.innerHTML = '';

      list.forEach(a => {
        const badge = getDateBadge(a.date);
        const row = document.createElement('a');
        row.href = '/activities.html?id=' + (a.id || '');
        row.className = 'activity-row block px-4';
        row.innerHTML =
          '<span class="badge ' + badge.cls + '">' + badge.text + '</span>' +
          '<div class="body">' +
            '<div class="name">' + (a.name || 'æœªå‘½åæ´»åŠ¨') + '</div>' +
            '<div class="meta">' + getVenueDisplay(a) + ' Â· ' + formatActivityDate(a.date) + '</div>' +
          '</div>' +
          '<span class="arrow">â†’</span>';
        itemsEl.appendChild(row);
      });
    } catch (e) {
      emptyEl.classList.remove('hidden');
      itemsEl.classList.add('hidden');
    }
  }

  async function health() {
    const textEl = document.getElementById('healthText');
    const timeEl = document.getElementById('healthTime');
    try {
      const res = await fetch('/health');
      if (!res.ok) throw new Error('health');
      const data = await res.json();
      textEl.textContent = 'æœåŠ¡æ­£å¸¸';
      timeEl.textContent = data.timestamp ? new Date(data.timestamp).toLocaleString('zh-CN') : '';
    } catch (e) {
      textEl.textContent = 'æœåŠ¡å¼‚å¸¸';
      timeEl.textContent = '';
    }
  }

  function setBottomNavActive() {
    const path = window.location.pathname;
    const key = path === '/dashboard.html' ? 'dashboard' : path === '/tactics.html' ? 'tactics' : path === '/profile.html' ? 'me' : 'dashboard';
    document.querySelectorAll('.bottom-nav-item').forEach(a => {
      a.classList.toggle('active', a.dataset.nav === key);
    });
  }

  (function bindWeekendCardClick() {
    var weekendCard = document.getElementById('weekendCard');
    var btnEl = document.getElementById('weekendRegisterBtn');
    if (!weekendCard) return;
    weekendCard.addEventListener('click', function (e) {
      if (btnEl && (e.target === btnEl || btnEl.contains(e.target))) return;
      var id = weekendCard.dataset.activityId;
      if (id) window.location.href = '/activities.html?id=' + id;
    });
  })();

  (function init() {
    setTimeout(function () {
      token = localStorage.getItem(TOKEN_KEY);
      // #region agent log
      (function(d){fetch('http://127.0.0.1:7242/ingest/f9c175ba-04d6-464f-bb6b-0d5e0ace1822',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(function(){});})({location:'dashboard.html:init',message:'token read',data:{origin:window.location.origin,hasToken:!!token,tokenLen:token?token.length:0},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H4'});
      // #endregion
      if (!token) {
        requireLogin('æ—  tokenï¼ˆè¯·ç¡®ä¿ä»ç™»å½•é¡µè·³è½¬ä¸”æœªæ¸…é™¤ç¼“å­˜ï¼‰');
        return;
      }
      (async function () {
        await loadMe();
        loadWeekendActivity();
        loadAllActivities();
        health();
        setBottomNavActive();
      })();
    }, 0);
  })();
})();
  </script>
</body>
</html>
