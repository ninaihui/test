<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>首页 - 业余球队管理系统</title>
  <link rel="stylesheet" href="/assets/app.css?v=20260130-1" />
  <style>
    .card { background: rgba(0,0,0,.25); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,.1); }
    .card-hover:hover { background: rgba(0,0,0,.35); border-color: rgba(255,255,255,.18); }
    .stat-num { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="min-h-screen bg-fifa">
<div class="min-h-screen safe-bottom pb-20">

  <div class="max-w-2xl mx-auto px-4 py-6">

    <!-- 头部：用户信息 -->
    <header class="flex items-center gap-3 mb-6">
      <div class="w-12 h-12 rounded-full overflow-hidden ring-2 ring-white/15 bg-black/30 shrink-0">
        <img id="avatar" alt="头像" class="w-full h-full object-cover" />
      </div>
      <div class="min-w-0">
        <div id="greeting" class="text-white/60 text-sm">加载中…</div>
        <div id="userName" class="text-white font-semibold truncate">—</div>
      </div>
    </header>

    <!-- 当前球队卡片 -->
    <section class="mb-6" id="teamSection">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-white/80 text-sm font-medium">当前球队</h2>
        <a href="/teams.html" class="text-cyan-400/90 text-xs hover:underline">管理</a>
      </div>
      <a href="/teams.html" id="teamCard" class="block card card-hover rounded-2xl p-4 transition">
        <div id="teamEmpty" class="hidden text-white/50 text-sm">暂无球队，去创建或加入</div>
        <div id="teamContent" class="hidden">
          <div id="teamName" class="text-white font-semibold mb-2">—</div>
          <div class="flex gap-4 text-xs text-white/60">
            <span><span id="teamMembers" class="stat-num text-white/80">0</span> 人</span>
            <span><span id="teamActivities" class="stat-num text-white/80">0</span> 场活动</span>
          </div>
        </div>
      </a>
    </section>

    <!-- 即将到来的活动 -->
    <section class="mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-white/80 text-sm font-medium">即将到来</h2>
        <a href="/activities.html" class="text-cyan-400/90 text-xs hover:underline">全部</a>
      </div>
      <div id="activitiesList">
        <div id="activitiesEmpty" class="card rounded-2xl p-4 text-center text-white/50 text-sm">暂无即将举行的活动</div>
        <div id="activityItems" class="space-y-2 hidden"></div>
        <template id="activityItemTpl">
          <a href="/activities.html" class="block card card-hover rounded-xl p-3 transition">
            <div class="flex justify-between items-start gap-2">
              <div class="min-w-0">
                <div class="text-white font-medium truncate" data-name></div>
                <div class="text-white/50 text-xs mt-0.5" data-location></div>
              </div>
              <div class="text-right shrink-0 text-white/70 text-xs whitespace-nowrap" data-date></div>
            </div>
          </a>
        </template>
      </div>
    </section>

    <!-- 出勤概览（有当前球队时显示） -->
    <section class="mb-6" id="attendanceSection">
      <h2 class="text-white/80 text-sm font-medium mb-3">出勤概览</h2>
      <div id="attendanceCard" class="card rounded-2xl p-4">
        <div id="attendanceEmpty" class="hidden text-white/50 text-sm">选择球队后可看出勤统计</div>
        <div id="attendanceContent" class="hidden flex items-center justify-between gap-4">
          <div>
            <div class="text-2xl font-bold text-white stat-num" id="attendanceRate">—</div>
            <div class="text-white/50 text-xs">出勤率</div>
          </div>
          <div class="flex gap-4 text-xs text-white/60">
            <span>到场 <span id="attPresent" class="text-emerald-400/90 stat-num">0</span></span>
            <span>缺席 <span id="attAbsent" class="text-red-400/90 stat-num">0</span></span>
            <span>迟到 <span id="attLate" class="text-amber-400/90 stat-num">0</span></span>
          </div>
        </div>
      </div>
    </section>

    <!-- 快捷入口 -->
    <section class="mb-6">
      <h2 class="text-white/80 text-sm font-medium mb-3">快捷入口</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
        <a href="/teams.html" class="card card-hover rounded-xl p-4 text-center transition">
          <div class="text-white font-medium text-sm">球队</div>
          <div class="text-white/50 text-xs mt-1">管理与加入</div>
        </a>
        <a href="/activities.html" class="card card-hover rounded-xl p-4 text-center transition">
          <div class="text-white font-medium text-sm">活动</div>
          <div class="text-white/50 text-xs mt-1">训练与比赛</div>
        </a>
        <a href="/attendance.html" class="card card-hover rounded-xl p-4 text-center transition">
          <div class="text-white font-medium text-sm">考勤</div>
          <div class="text-white/50 text-xs mt-1">签到与统计</div>
        </a>
        <a href="/tactics.html" class="card card-hover rounded-xl p-4 text-center transition">
          <div class="text-white font-medium text-sm">战术板</div>
          <div class="text-white/50 text-xs mt-1">阵容与战术</div>
        </a>
      </div>
    </section>

    <!-- 我的 -->
    <section class="mb-4">
      <a href="/profile.html" class="block card card-hover rounded-2xl p-4 transition">
        <div class="flex items-center justify-between">
          <span class="text-white font-medium">我的</span>
          <span class="text-white/40 text-sm">个人资料与设置</span>
        </div>
      </a>
    </section>

    <!-- 服务状态 -->
    <div class="text-white/40 text-xs flex items-center gap-2">
      <span id="healthText">检查中…</span>
      <span id="healthTime"></span>
    </div>

  </div>
</div>

<!-- 底部导航 -->
<nav class="bottom-nav" aria-label="底部导航">
  <div class="bottom-nav-inner">
    <a class="bottom-nav-item active" data-nav="dashboard" href="/dashboard.html">首页</a>
    <a class="bottom-nav-item" data-nav="teams" href="/teams.html">球队</a>
    <a class="bottom-nav-item" data-nav="tactics" href="/tactics.html">战术板</a>
    <a class="bottom-nav-item" data-nav="me" href="/profile.html">我的</a>
  </div>
</nav>

<script src="/js/fancy-background.js"></script>
<script>
(function () {
  const TOKEN_KEY = 'authToken';
  const USER_KEY = 'user';
  const CURRENT_TEAM_KEY = 'team_management:currentTeamId';
  const CURRENT_TEAM_NAME_KEY = 'team_management:currentTeamName';

  const token = localStorage.getItem(TOKEN_KEY);
  const avatarEl = document.getElementById('avatar');
  const greetingEl = document.getElementById('greeting');
  const nameEl = document.getElementById('userName');

  function requireLogin() {
    window.location.href = '/login.html';
  }

  function setGreeting(username) {
    const hour = new Date().getHours();
    let timeLabel = '你好';
    if (hour >= 5 && hour < 12) timeLabel = '早上好';
    else if (hour >= 12 && hour < 18) timeLabel = '下午好';
    else if (hour >= 18) timeLabel = '晚上好';
    greetingEl.textContent = timeLabel + '，';
    nameEl.textContent = username || '用户';
  }

  async function loadMe() {
    if (!token) return requireLogin();
    try {
      const res = await fetch('/auth/me', { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return requireLogin();
      const me = await res.json();
      setGreeting(me.username);
      avatarEl.src = (me.avatarUrl ? (me.avatarUrl + '?t=' + Date.now()) : 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Crect%20width%3D%22128%22%20height%3D%22128%22%20rx%3D%2264%22%20fill%3D%22%230b1220%22/%3E%3Ctext%20x%3D%2264%22%20y%3D%2276%22%20font-family%3D%22ui-sans-serif%2C%20system-ui%22%20font-size%3D%2246%22%20font-weight%3D%22800%22%20text-anchor%3D%22middle%22%20fill%3D%22rgba(255%2C255%2C255%2C0.85)%22%3E%3F%3C/text%3E%3C/svg%3E');
      localStorage.setItem(USER_KEY, JSON.stringify(me));
    } catch (e) {
      requireLogin();
    }
  }

  async function loadTeams() {
    const teamEmpty = document.getElementById('teamEmpty');
    const teamContent = document.getElementById('teamContent');
    const teamName = document.getElementById('teamName');
    const teamMembers = document.getElementById('teamMembers');
    const teamActivities = document.getElementById('teamActivities');

    try {
      const res = await fetch('/teams', { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return;
      const teams = await res.json();
      if (!Array.isArray(teams) || teams.length === 0) {
        teamEmpty.classList.remove('hidden');
        teamContent.classList.add('hidden');
        return;
      }
      const savedId = localStorage.getItem(CURRENT_TEAM_KEY);
      const current = teams.find(t => t.id === savedId) || teams[0];
      localStorage.setItem(CURRENT_TEAM_KEY, current.id);
      localStorage.setItem(CURRENT_TEAM_NAME_KEY, current.name || '未命名球队');

      teamEmpty.classList.add('hidden');
      teamContent.classList.remove('hidden');
      teamName.textContent = current.name || '未命名球队';
      teamMembers.textContent = (current._count && current._count.members) != null ? current._count.members : (current.members && current.members.length) || 0;
      teamActivities.textContent = (current._count && current._count.activities) != null ? current._count.activities : (current.activities && current.activities.length) || 0;
    } catch (e) {
      teamEmpty.classList.remove('hidden');
      teamContent.classList.add('hidden');
    }
  }

  function formatActivityDate(iso) {
    if (!iso) return '—';
    const d = new Date(iso);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    d.setHours(0, 0, 0, 0);
    if (d.getTime() === today.getTime()) return '今天 ' + new Date(iso).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    if (d.getTime() === tomorrow.getTime()) return '明天 ' + new Date(iso).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    return new Date(iso).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  async function loadUpcomingActivities() {
    const emptyEl = document.getElementById('activitiesEmpty');
    const itemsEl = document.getElementById('activityItems');
    const tpl = document.getElementById('activityItemTpl');

    try {
      const res = await fetch('/activities', { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return;
      const activities = await res.json();
      const now = new Date().toISOString();
      const upcoming = (Array.isArray(activities) ? activities : [])
        .filter(a => a.date && a.date >= now)
        .sort((a, b) => (a.date || '').localeCompare(b.date || ''))
        .slice(0, 5);

      emptyEl.classList.toggle('hidden', upcoming.length > 0);
      itemsEl.classList.toggle('hidden', upcoming.length === 0);
      itemsEl.innerHTML = '';
      upcoming.forEach(a => {
        const node = tpl.content.cloneNode(true);
        node.querySelector('[data-name]').textContent = a.name || '未命名活动';
        node.querySelector('[data-location]').textContent = a.location || '—';
        node.querySelector('[data-date]').textContent = formatActivityDate(a.date);
        itemsEl.appendChild(node);
      });
    } catch (e) {
      emptyEl.classList.remove('hidden');
      itemsEl.classList.add('hidden');
    }
  }

  async function loadAttendanceStats() {
    const currentTeamId = localStorage.getItem(CURRENT_TEAM_KEY);
    const emptyEl = document.getElementById('attendanceEmpty');
    const contentEl = document.getElementById('attendanceContent');
    const rateEl = document.getElementById('attendanceRate');
    const presentEl = document.getElementById('attPresent');
    const absentEl = document.getElementById('attAbsent');
    const lateEl = document.getElementById('attLate');

    if (!currentTeamId) {
      emptyEl.classList.remove('hidden');
      contentEl.classList.add('hidden');
      return;
    }
    try {
      const url = '/attendance/statistics?teamId=' + encodeURIComponent(currentTeamId);
      const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) throw new Error('stats');
      const stats = await res.json();
      emptyEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
      rateEl.textContent = stats.rate != null ? String(stats.rate) : '—';
      presentEl.textContent = stats.present != null ? stats.present : 0;
      absentEl.textContent = stats.absent != null ? stats.absent : 0;
      lateEl.textContent = stats.late != null ? stats.late : 0;
    } catch (e) {
      emptyEl.classList.remove('hidden');
      contentEl.classList.add('hidden');
    }
  }

  async function health() {
    const textEl = document.getElementById('healthText');
    const timeEl = document.getElementById('healthTime');
    try {
      const res = await fetch('/health');
      if (!res.ok) throw new Error('health');
      const data = await res.json();
      textEl.textContent = '服务正常';
      timeEl.textContent = data.timestamp ? new Date(data.timestamp).toLocaleString('zh-CN') : '';
    } catch (e) {
      textEl.textContent = '服务异常';
      timeEl.textContent = '';
    }
  }

  function setBottomNavActive() {
    const path = window.location.pathname;
    const key = path === '/dashboard.html' ? 'dashboard' : path === '/teams.html' ? 'teams' : path === '/tactics.html' ? 'tactics' : path === '/profile.html' ? 'me' : 'dashboard';
    document.querySelectorAll('.bottom-nav-item').forEach(a => {
      a.classList.toggle('active', a.dataset.nav === key);
    });
  }

  (async function init() {
    await loadMe();
    await loadTeams();
    loadUpcomingActivities();
    loadAttendanceStats();
    health();
    setBottomNavActive();
  })();
})();
</script>
</body>
</html>
