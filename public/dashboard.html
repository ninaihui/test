<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¦–é¡µ - ä¸šä½™çƒé˜Ÿç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="/assets/app.css?v=20260130-1" />
  <style>
    body { margin: 0; min-height: 100vh; color: #e2e8f0; box-sizing: border-box;
      background:
        radial-gradient(900px 480px at 20% 10%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(900px 480px at 85% 0%, rgba(16,185,129,.12), transparent 55%),
        linear-gradient(180deg, #070A12 0%, #0B1530 100%);
      background-attachment: fixed; }
    .card, .glass { background: rgba(255,255,255,.06); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .card-hover:hover { background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.16); }
    .stat-num { font-variant-numeric: tabular-nums; }
    /* æ¬¢è¿åŒº */
    .welcome-card { padding: 1rem 1.25rem; }
    .welcome-card a { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.75rem; }
    .welcome-card a:hover { opacity: 0.95; }
    /* ä¸‹ä¸€åœºæ´»åŠ¨ä¸»å¡ç‰‡ï¼šæ›´åƒå±•ç¤ºé¡µçš„â€œé«˜çº§ç»ç’ƒå¡â€ */
    .next-card { position: relative; padding: 1.25rem; overflow: hidden; border-radius: 1.25rem; }
    .next-card:before{ content:''; position:absolute; inset:-2px;
      background: radial-gradient(700px 380px at 18% 8%, rgba(59,130,246,.22), transparent 55%),
                  radial-gradient(700px 380px at 90% 0%, rgba(168,85,247,.16), transparent 55%);
      pointer-events:none; z-index: 0;
    }
    .next-card-weather-bg { position: absolute; inset: 0; z-index: 0; pointer-events: none; display: flex; align-items: flex-start; justify-content: flex-end; padding: 0; overflow: hidden; }
    .next-card-weather-bg .weather-bg-icon { font-size: 7rem; line-height: 1; opacity: 0.12; transform: translate(6%, -6%); }
    .next-card-weather-bg .weather-bg-temp { position: absolute; right: 0.85rem; top: 0.65rem; font-size: 1.4rem; font-weight: 900; color: rgba(255,255,255,.13); }
    .next-card-content { position: relative; z-index: 1; }
    #weekendCard[data-activity-id] { cursor: pointer; }
    .next-card .next-card-meta { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem; font-size: 0.875rem; color: rgba(255,255,255,.7); }
    .next-card .next-card-meta-sep { color: rgba(255,255,255,.4); flex-shrink: 0; }
    .next-card .meta-item { display: inline-flex; align-items: center; gap: 0.35rem; }
    .next-card .meta-item .meta-icon { display: inline-flex; flex-shrink: 0; width: 1rem; height: 1rem; color: rgba(255,255,255,.75); }
    .next-card .meta-item .meta-icon svg { width: 100%; height: 100%; }
    .next-card .cta { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,.1); display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; }
    .badge-today { background: rgba(34,197,94,.25); color: #86efac; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    .badge-tomorrow { background: rgba(59,130,246,.25); color: #93c5fd; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    .badge-date { background: rgba(255,255,255,.1); color: rgba(255,255,255,.7); padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
    /* ä¸‹ä¸€åœºæ´»åŠ¨ - æŠ¥åé˜Ÿå‘˜é¢„è§ˆ */
    .next-card .roster-label { font-size: 0.75rem; color: rgba(255,255,255,.5); margin-top: 0.75rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem; }
    .next-card .roster-count { font-size: 0.75rem; color: rgba(255,255,255,.6); font-variant-numeric: tabular-nums; }
    .next-card .roster-names { font-size: 0.8125rem; color: rgba(255,255,255,.75); line-height: 1.4; }
    .next-card .roster-names .name-tag { display: inline-flex; align-items: center; margin: 0.125rem 0.25rem 0.125rem 0;
      padding: 0.18rem 0.55rem; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px; font-size: 0.75rem; color: rgba(255,255,255,.82);
    }

    /* ç®€çº¦å¤§æ°”ï¼šå±é™©æŒ‰é’®æ›´å…‹åˆ¶ï¼ˆä¸æŠ¢ä¸»æ“ä½œï¼‰ */
    .btn-danger-soft { background: rgba(239,68,68,.10) !important; border: 1px solid rgba(239,68,68,.32) !important; color: rgba(254,202,202,.95) !important; box-shadow: none !important; }
    .btn-danger-soft:hover { background: rgba(239,68,68,.14) !important; border-color: rgba(239,68,68,.46) !important; }

    /* æ´»åŠ¨åˆ—è¡¨é¡¹ï¼šæ˜ŸæœŸä¸ç®­å¤´ç•™å‡ºè¾¹è·ï¼Œä¸è´´è¾¹ */
    .activity-row { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,.08); text-decoration: none; color: inherit; transition: background .15s; }
    .activity-row:last-child { border-bottom: none; }
    .activity-row:hover { background: rgba(255,255,255,.05); }
    .activity-row .badge { flex-shrink: 0; min-width: 3rem; text-align: center; margin-left: 0.125rem; }
    .activity-row .body { flex: 1; min-width: 0; }
    .activity-row .body .name { font-weight: 500; color: #fff; }
    .activity-row .body .meta { font-size: 0.8125rem; color: rgba(255,255,255,.5); margin-top: 0.125rem; }
    .activity-row .arrow { color: rgba(255,255,255,.4); flex-shrink: 0; display: flex; align-items: center; justify-content: center; margin-right: 0.125rem; transition: color .2s, transform .2s; }
    .activity-row:hover .arrow { color: rgba(255,255,255,.7); transform: translateX(2px); }
    .activity-row .arrow svg { width: 1.25rem; height: 1.25rem; }
    .welcome-card .nav-arrow { color: rgba(255,255,255,.4); display: inline-flex; align-items: center; transition: color .2s, transform .2s; }
    .welcome-card a:hover .nav-arrow { color: rgba(255,255,255,.7); transform: translateX(2px); }
    .welcome-card .nav-arrow svg { width: 1.25rem; height: 1.25rem; }
    /* æ¬¢è¿åŒºå¤´åƒï¼šä¸ã€Œæˆ‘çš„ã€é¡µé¢ä¸€è‡´ 5rem Ã— 5rem */
    .welcome-avatar { width: 5rem; height: 5rem; min-width: 5rem; min-height: 5rem; border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,.2); background: rgba(0,0,0,.2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .welcome-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
    /* æŠ¥åå¼¹çª—ï¼šå‡ºåœºä½ç½®é€‰æ‹© */
    .register-modal-overlay { position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; padding: 1rem; }
    .register-modal-overlay.show { display: flex; }
    .register-modal { width: 100%; max-width: 22rem; background: rgba(15,23,42,.95); border: 1px solid rgba(255,255,255,.15); border-radius: 1rem; padding: 1.25rem; box-shadow: 0 20px 40px rgba(0,0,0,.4); }
    .register-modal h3 { margin: 0 0 1rem; font-size: 1rem; font-weight: 600; color: #fff; }
    .register-modal .modal-select { width: 100%; padding: 0.625rem 0.75rem; border-radius: 0.5rem; font-size: 0.9375rem; color: #fff; background: rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,.2); margin-bottom: 1rem; }
    .register-modal .modal-select:focus { outline: none; border-color: rgba(34,197,94,.6); }
    .register-modal .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
    .register-modal .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; border: none; }
    .register-modal .btn-ghost { background: rgba(255,255,255,.1); color: #e2e8f0; }
    .register-modal .btn-ghost:hover { background: rgba(255,255,255,.15); }
    /* å·²æŠ¥åè§’æ ‡ï¼šä¸æ ‡é¢˜åŒè¡Œï¼Œä¸é®æŒ¡ç®­å¤´ */
    .registered-badge { white-space: nowrap; flex-shrink: 0; background: rgba(16,185,129,0.22); border: 1px solid rgba(16,185,129,0.5); color: #a7f3d0; }
    .registered-badge svg { width: 0.875rem; height: 0.875rem; flex-shrink: 0; }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <!-- ç™»å‡ºæŒ‰é’®å·²ç§»é™¤ -->
  <div class="min-h-screen safe-bottom-nav">
    <div class="max-w-2xl mx-auto px-4 py-6">

      <!-- æ¬¢è¿åŒºï¼šå¤´åƒ + é—®å€™ + å‰¯æ ‡é¢˜ -->
      <section class="mb-6">
        <a href="/profile.html" class="card rounded-2xl welcome-card card-hover transition block">
          <div class="flex items-center gap-3">
            <div class="welcome-avatar">
              <img id="avatar" alt="å¤´åƒ" />
            </div>
            <div class="min-w-0 flex-1">
              <div id="greeting" class="text-white/70 text-sm">åŠ è½½ä¸­â€¦</div>
              <div id="userName" class="text-white font-semibold truncate text-lg">â€”</div>
              <div class="text-white/50 text-xs mt-0.5">ç‚¹å‡»è¿›å…¥ä¸ªäººä¸­å¿ƒ</div>
            </div>
            <span class="nav-arrow shrink-0" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></span>
          </div>
        </a>
      </section>

      <!-- ä¸‹ä¸€åœºæ´»åŠ¨ï¼ˆä¸»å¡ç‰‡ï¼Œå¤©æ°”ä¸ºèƒŒæ™¯ï¼‰ -->
      <section class="mb-6" id="weekendSection">
        <h2 class="text-white/80 text-sm font-medium mb-3">ä¸‹ä¸€åœºæ´»åŠ¨</h2>
        <div id="weekendCard" class="card rounded-2xl next-card">
          <div id="weekendCardWeatherBg" class="next-card-weather-bg" aria-hidden="true"></div>
          <div id="weekendEmpty" class="text-white/50 text-sm text-center py-6">
            æš‚æ— å³å°†ä¸¾è¡Œçš„æ´»åŠ¨<br />
            <a href="/activities.html" class="text-cyan-400/90 text-xs mt-2 inline-block underline">å»æ´»åŠ¨é¡µçœ‹çœ‹</a>
          </div>
          <div id="weekendContent" class="next-card-content hidden">
            <div id="weekendName" class="text-white font-semibold text-lg">â€”</div>
            <div class="next-card-meta">
              <span id="weekendVenue">â€”</span>
              <span class="next-card-meta-sep"> Â· </span>
              <span id="weekendTime">â€”</span>
            </div>
            <div id="weekendRoster" class="hidden">
              <div class="roster-label"><span>å·²æŠ¥åé˜Ÿå‘˜</span><span id="weekendRosterCount" class="roster-count">0/11</span></div>
              <div id="weekendRosterNames" class="roster-names"></div>
            </div>
            <div class="cta" style="border-top-color: rgba(255,255,255,.12)">
              <span id="weekendStatus" class="text-white/60 text-sm">â€”</span>
              <button type="button" id="weekendRegisterBtn" class="btn btn-primary hidden" style="border-radius:999px; padding:.62rem .95rem; font-weight:800; min-width: 108px;">æŠ¥å</button>
            </div>
          </div>
        </div>
      </section>

      <!-- å…¨éƒ¨æ´»åŠ¨ï¼ˆå·²åˆ›å»ºçš„æ‰€æœ‰æ´»åŠ¨ï¼‰ -->
      <section class="mb-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-white/80 text-sm font-medium">å…¨éƒ¨æ´»åŠ¨</h2>
          <a href="/activities.html" class="text-cyan-400/90 text-xs hover:underline">æ´»åŠ¨é¡µ</a>
        </div>
        <div id="activitiesList" class="card rounded-2xl overflow-hidden">
          <div id="activitiesEmpty" class="text-white/50 text-sm text-center py-6 px-4">
            æš‚æ— æ´»åŠ¨<br />
            <a href="/activities.html" class="text-cyan-400/90 text-xs mt-2 inline-block underline">å»æ´»åŠ¨é¡µ</a>
          </div>
          <div id="activityItems" class="hidden">
            <!-- ç”± JS å¡«å…… -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- æŠ¥åå¼¹çª—ï¼šé˜Ÿä¼ + å‡ºåœºä½ç½®ï¼ˆä¸æ´»åŠ¨è¯¦æƒ…é¡µä¿æŒä¸€è‡´ï¼‰ -->
  <div id="registerModalOverlay" class="register-modal-overlay" aria-hidden="true">
    <div class="register-modal" role="dialog" aria-labelledby="registerModalTitle" aria-modal="true">
      <h3 id="registerModalTitle">æŠ¥åè®¾ç½®</h3>
      <select id="registerTeamSelect" class="modal-select" aria-label="é˜Ÿä¼">
        <option value="0">æœªå®š</option>
      </select>
      <select id="registerPositionSelect" class="modal-select" aria-label="å‡ºåœºä½ç½®">
        <option value="">æœªé€‰æ‹©</option>
        <optgroup label="å®ˆé—¨å‘˜">
          <option value="å®ˆé—¨å‘˜">å®ˆé—¨å‘˜ (GK)</option>
        </optgroup>
        <optgroup label="åå«">
          <option value="ä¸­åå«">ä¸­åå« (CB)</option>
          <option value="å³åå«">å³åå« (RB)</option>
          <option value="å·¦åå«">å·¦åå« (LB)</option>
        </optgroup>
        <optgroup label="ä¸­åœº">
          <option value="åè…°">åè…° (DM)</option>
          <option value="ä¸­å‰å«">ä¸­å‰å« (CM)</option>
          <option value="å‰è…°">å‰è…° (AM)</option>
          <option value="å³å‰å«">å³å‰å« (RM)</option>
          <option value="å·¦å‰å«">å·¦å‰å« (LM)</option>
          <option value="å³è¾¹é”‹">å³è¾¹é”‹ (RW)</option>
          <option value="å·¦è¾¹é”‹">å·¦è¾¹é”‹ (LW)</option>
        </optgroup>
        <optgroup label="å‰é”‹">
          <option value="å½±é”‹">å½±é”‹ (SS)</option>
          <option value="ä¸­é”‹">ä¸­é”‹ (CF)</option>
          <option value="å‰é”‹">å‰é”‹ (ST)</option>
        </optgroup>
      </select>
      <div class="modal-actions">
        <button type="button" id="registerModalCancel" class="btn btn-ghost">å–æ¶ˆ</button>
        <button type="button" id="registerModalConfirm" class="btn btn-primary">ç¡®å®šæŠ¥å</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav" aria-label="åº•éƒ¨å¯¼èˆª">
    <div class="bottom-nav-inner">
      <a class="bottom-nav-item active" data-nav="dashboard" href="/dashboard.html">é¦–é¡µ</a>
      <a class="bottom-nav-item" data-nav="activities" href="/activities.html">æ´»åŠ¨</a>
      <a class="bottom-nav-item" data-nav="me" href="/profile.html">æˆ‘çš„</a>
    </div>
  </nav>

  <!-- fancy-background removed for minimalist UI -->
  <script src="/js/position-options.js"></script>
  <script>
(function () {
  const TOKEN_KEY = 'authToken';
  const USER_KEY = 'user';

  function escapeHtml(s) {
    if (s == null) return '';
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  var token = null;
  const avatarEl = document.getElementById('avatar');
  const greetingEl = document.getElementById('greeting');
  const nameEl = document.getElementById('userName');

  const defaultAvatar = 'data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22128%22%20height%3D%22128%22%20viewBox%3D%220%200%20128%20128%22%3E%3Crect%20width%3D%22128%22%20height%3D%22128%22%20rx%3D%2264%22%20fill%3D%22%230b1220%22/%3E%3Ctext%20x%3D%2264%22%20y%3D%2276%22%20font-family%3D%22ui-sans-serif%2C%20system-ui%22%20font-size%3D%2246%22%20font-weight%3D%22800%22%20text-anchor%3D%22middle%22%20fill%3D%22rgba(255%2C255%2C255%2C0.85)%22%3E%3F%3C/text%3E%3C/svg%3E';

  function toAbsoluteAvatarUrl(url) {
    if (!url) return '';
    if (url.startsWith('http://') || url.startsWith('https://')) return url;
    var path = url.startsWith('/') ? url : '/' + url;
    return window.location.origin + path;
  }

  function requireLogin(reason) {
    // #region agent log
    (function(d){fetch('http://127.0.0.1:7242/ingest/f9c175ba-04d6-464f-bb6b-0d5e0ace1822',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(function(){});})({location:'dashboard.html:requireLogin',message:'redirecting to login',data:{reason:reason||'',origin:window.location.origin},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H4,H5'});
    // #endregion
    console.warn('é¦–é¡µï¼šè·³è½¬ç™»å½•é¡µ â€”', reason || 'æœªç™»å½•æˆ–ç™»å½•å·²å¤±æ•ˆ');
    window.location.href = window.location.origin + '/login.html';
  }

  function setGreeting(username) {
    const hour = new Date().getHours();
    let timeLabel = 'ä½ å¥½';
    if (hour >= 5 && hour < 12) timeLabel = 'æ—©ä¸Šå¥½';
    else if (hour >= 12 && hour < 18) timeLabel = 'ä¸‹åˆå¥½';
    else if (hour >= 18) timeLabel = 'æ™šä¸Šå¥½';
    greetingEl.textContent = timeLabel + 'ï¼Œ';
    nameEl.textContent = username || 'ç”¨æˆ·';
  }

  async function loadMe() {
    var t = token || localStorage.getItem(TOKEN_KEY) || sessionStorage.getItem(TOKEN_KEY);
    if (!t) {
      requireLogin('æ—  token');
      return;
    }
    try {
      const res = await fetch('/auth/me', { headers: { Authorization: 'Bearer ' + t } });
      // #region agent log
      (function(d){fetch('http://127.0.0.1:7242/ingest/f9c175ba-04d6-464f-bb6b-0d5e0ace1822',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(function(){});})({location:'dashboard.html:loadMe',message:'/auth/me response',data:{status:res.status,ok:res.ok},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H5'});
      // #endregion
      if (!res.ok) {
        console.warn('é¦–é¡µï¼š/auth/me è¿”å›', res.status);
        requireLogin('/auth/me è¿”å› ' + res.status);
        return;
      }
      const me = await res.json();
      setGreeting(me.username);
      if (me.avatarUrl) {
        var avatarSrc = toAbsoluteAvatarUrl(me.avatarUrl);
        avatarEl.src = avatarSrc + (avatarSrc.indexOf('?') >= 0 ? '&' : '?') + 't=' + Date.now();
      } else {
        avatarEl.src = defaultAvatar;
      }
      avatarEl.onerror = function () { avatarEl.src = defaultAvatar; };
      localStorage.setItem(USER_KEY, JSON.stringify(me));
    } catch (e) {
      console.warn('é¦–é¡µï¼š/auth/me è¯·æ±‚å¤±è´¥', e);
      requireLogin('è¯·æ±‚ /auth/me å¤±è´¥');
    }
  }

  var weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

  function getDayChip(iso) {
    try {
      if (!iso) return { m: '', d: '', wd: '' };
      var dt = new Date(iso);
      var m = String(dt.getMonth() + 1);
      var day = String(dt.getDate());
      var wds = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      var wd = 'å‘¨' + (wds[dt.getDay()] || '');
      return { m: m, d: day, wd: wd };
    } catch (e) {
      return { m: '', d: '', wd: '' };
    }
  }

  function formatActivityDate(iso) {
    if (!iso) return 'â€”';
    const d = new Date(iso);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    d.setHours(0, 0, 0, 0);
    var w = weekdays[d.getDay()];
    var timeStr = new Date(iso).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    if (d.getTime() === today.getTime()) return 'ä»Šå¤© ' + w + ' ' + timeStr;
    if (d.getTime() === tomorrow.getTime()) return 'æ˜å¤© ' + w + ' ' + timeStr;
    return (d.getMonth() + 1) + 'æœˆ' + d.getDate() + 'å· ' + w + ' ' + timeStr;
  }

  function getDateBadge(iso) {
    if (!iso) return { text: 'â€”', cls: 'badge-date' };
    const d = new Date(iso);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    d.setHours(0, 0, 0, 0);
    if (d.getTime() === today.getTime()) return { text: 'ä»Šå¤©', cls: 'badge-today' };
    if (d.getTime() === tomorrow.getTime()) return { text: 'æ˜å¤©', cls: 'badge-tomorrow' };
    const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
    return { text: (d.getMonth() + 1) + 'æœˆ' + d.getDate() + 'å· å‘¨' + week, cls: 'badge-date' };
  }

  function getVenueDisplay(activity) {
    if (activity.venue && activity.venue.name) return activity.venue.name;
    return activity.location || 'â€”';
  }

  function weatherCodeToDesc(code) {
    if (code == null) return 'â€”';
    var c = parseInt(code, 10);
    if (c === 0) return 'æ™´';
    if (c >= 1 && c <= 3) return ['å°‘äº‘', 'å¤šäº‘', 'é˜´'][c - 1];
    if (c === 45 || c === 48) return 'é›¾';
    if (c >= 51 && c <= 67) return 'é›¨';
    if (c >= 71 && c <= 77) return 'é›ª';
    if (c >= 80 && c <= 82) return 'é˜µé›¨';
    if (c >= 85 && c <= 86) return 'é˜µé›ª';
    if (c >= 95 && c <= 99) return 'é›·æš´';
    return 'â€”';
  }

  function weatherCodeToIcon(code) {
    if (code == null) return 'ğŸŒ¤';
    var c = parseInt(code, 10);
    if (c === 0) return 'â˜€ï¸';
    if (c >= 1 && c <= 3) return 'â›…';
    if (c === 45 || c === 48) return 'ğŸŒ«';
    if (c >= 51 && c <= 67) return 'ğŸŒ§';
    if (c >= 71 && c <= 77) return 'ğŸŒ¨';
    if (c >= 80 && c <= 82) return 'ğŸŒ¦';
    if (c >= 85 && c <= 86) return 'ğŸŒ¨';
    if (c >= 95 && c <= 99) return 'â›ˆ';
    return 'ğŸŒ¤';
  }

  function formatActivityDateForApi(iso) {
    if (!iso) return '';
    var d = new Date(iso);
    var y = d.getFullYear();
    var m = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    return y + '-' + m + '-' + day;
  }

  async function loadWeatherForActivity(activity, venueDisplay) {
    var weatherBg = document.getElementById('weekendCardWeatherBg');
    if (!weatherBg) return;
    var setLoading = function () {
      weatherBg.innerHTML = '';
    };
    var setError = function () {
      weatherBg.innerHTML = '';
    };
    var dateStr = formatActivityDateForApi(activity.date);
    if (!dateStr) { setError(); return; }
    var lat = 35.6762;
    var lon = 139.6503;
    var searchName = (venueDisplay && venueDisplay !== 'â€”') ? venueDisplay : 'ä¸œäº¬';
    try {
      var geoRes = await fetch('https://geocoding-api.open-meteo.com/v1/search?name=' + encodeURIComponent(searchName) + '&count=1&language=zh');
      if (geoRes.ok) {
        var geo = await geoRes.json();
        if (geo.results && geo.results[0]) {
          lat = geo.results[0].latitude;
          lon = geo.results[0].longitude;
        }
      }
    } catch (e) {}
    try {
      var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon +
        '&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=Asia%2FTokyo' +
        '&start_date=' + dateStr + '&end_date=' + dateStr;
      var forecastRes = await fetch(url);
      if (!forecastRes.ok) { setError(); return; }
      var data = await forecastRes.json();
      var daily = data.daily;
      if (!daily || !daily.time || !daily.time[0]) { setError(); return; }
      var maxT = daily.temperature_2m_max && daily.temperature_2m_max[0];
      var minT = daily.temperature_2m_min && daily.temperature_2m_min[0];
      var code = daily.weathercode && daily.weathercode[0];
      var tempStr = (minT != null && maxT != null) ? (Math.round(minT) + '~' + Math.round(maxT) + 'Â°C') : '';
      weatherBg.innerHTML =
        '<span class="weather-bg-icon" aria-hidden="true">' + weatherCodeToIcon(code) + '</span>' +
        (tempStr ? '<span class="weather-bg-temp">' + tempStr + '</span>' : '');
    } catch (e) {
      setError();
    }
  }

  async function loadWeekendActivity() {
    const emptyEl = document.getElementById('weekendEmpty');
    const contentEl = document.getElementById('weekendContent');
    const nameEl = document.getElementById('weekendName');
    const venueEl = document.getElementById('weekendVenue');
    const timeEl = document.getElementById('weekendTime');
    const statusEl = document.getElementById('weekendStatus');
    const btnEl = document.getElementById('weekendRegisterBtn');

    try {
      const res = await fetch('/activities?upcoming=1', { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return;
      const activities = await res.json();
      const list = Array.isArray(activities) ? activities : [];
      const first = list[0];
      if (!first || !first.id) {
        var cardEl = document.getElementById('weekendCard');
        var weatherBg = document.getElementById('weekendCardWeatherBg');
        if (cardEl) delete cardEl.dataset.activityId;
        if (weatherBg) weatherBg.innerHTML = '';
        emptyEl.hidden = false;
        contentEl.hidden = true;
        emptyEl.classList.remove('hidden');
        contentEl.classList.add('hidden');
        return;
      }
      const detailRes = await fetch('/activities/' + first.id, { headers: { Authorization: 'Bearer ' + token } });
      if (!detailRes.ok) {
        var cardEl = document.getElementById('weekendCard');
        var weatherBg = document.getElementById('weekendCardWeatherBg');
        if (cardEl) delete cardEl.dataset.activityId;
        if (weatherBg) weatherBg.innerHTML = '';
        emptyEl.hidden = false;
        contentEl.hidden = true;
        emptyEl.classList.remove('hidden');
        contentEl.classList.add('hidden');
        return;
      }
      const activity = await detailRes.json();
      const userStr = localStorage.getItem(USER_KEY);
      const me = userStr ? JSON.parse(userStr) : null;
      const myAtt = (activity.attendances || []).find(a => a.user && a.user.id === (me && me.id));
      const venueDisplay = getVenueDisplay(activity);

      emptyEl.hidden = true;
      contentEl.hidden = false;
      emptyEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
      var weekendCard = document.getElementById('weekendCard');
      if (weekendCard) weekendCard.dataset.activityId = activity.id;
      var nameText = activity.name || 'æœªå‘½åæ´»åŠ¨';
      nameEl.textContent = nameText.length > 17 ? nameText.slice(0, 17) + 'â€¦' : nameText;
      var locationIcon = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg></span>';
      var clockIcon = '<span class="meta-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></span>';
      venueEl.className = 'meta-item';
      timeEl.className = 'meta-item';
      var venueText = (venueDisplay && venueDisplay.length > 15) ? venueDisplay.slice(0, 15) + 'â€¦' : (venueDisplay || 'â€”');
      venueEl.innerHTML = locationIcon + '<span>' + escapeHtml(venueText) + '</span>';
      timeEl.innerHTML = clockIcon + '<span>' + escapeHtml(formatActivityDate(activity.date)) + '</span>';

      loadWeatherForActivity(activity, venueDisplay);

      var rosterWrap = document.getElementById('weekendRoster');
      var rosterNamesEl = document.getElementById('weekendRosterNames');
      var rosterCountEl = document.getElementById('weekendRosterCount');
      var attendances = activity.attendances || [];
      var totalSlots = (activity.maxParticipants != null && activity.maxParticipants >= 1) ? activity.maxParticipants : 14;
      var regAttendances = attendances.filter(function(a){ return a && a.status !== 'waitlist'; });
      var waitCount = attendances.filter(function(a){ return a && a.status === 'waitlist'; }).length;
      if (rosterCountEl) rosterCountEl.textContent = regAttendances.length + '/' + totalSlots + (waitCount > 0 ? (' Â· å€™è¡¥' + waitCount) : '');
      if (rosterWrap && rosterNamesEl) {
        if (regAttendances.length > 0) {
          rosterWrap.classList.remove('hidden');
          rosterNamesEl.innerHTML = regAttendances.map(function (a) {
            var name = (a.user && a.user.username) ? a.user.username : 'â€”';
            var pos = (a.position != null && String(a.position).trim()) ? String(a.position).trim() : ((a.user && a.user.playingPosition && a.user.playingPosition.trim()) ? a.user.playingPosition.trim() : 'æœªè®¾ç½®');
            return '<span class="name-tag">' + escapeHtml(name) + ' Â· ' + escapeHtml(pos) + '</span>';
          }).join('');
        } else {
          rosterWrap.classList.add('hidden');
          rosterNamesEl.innerHTML = '';
        }
        if (rosterCountEl) rosterCountEl.textContent = regAttendances.length + '/' + totalSlots + (waitCount > 0 ? (' Â· å€™è¡¥' + waitCount) : '');
      }

      function showToast(message) {
        try {
          var existing = document.getElementById('toast');
          if (!existing) {
            existing = document.createElement('div');
            existing.id = 'toast';
            existing.style.position = 'fixed';
            existing.style.left = '50%';
            existing.style.bottom = 'calc(80px + env(safe-area-inset-bottom))';
            existing.style.transform = 'translateX(-50%)';
            existing.style.zIndex = '200';
            existing.style.maxWidth = '92vw';
            existing.style.padding = '10px 12px';
            existing.style.borderRadius = '999px';
            existing.style.background = 'rgba(15,23,42,0.95)';
            existing.style.border = '1px solid rgba(255,255,255,0.18)';
            existing.style.boxShadow = '0 12px 28px rgba(0,0,0,0.35)';
            existing.style.color = '#e2e8f0';
            existing.style.fontSize = '14px';
            existing.style.opacity = '0';
            existing.style.transition = 'opacity .15s ease, transform .15s ease';
            document.body.appendChild(existing);
          }
          existing.textContent = message;
          existing.style.opacity = '1';
          existing.style.transform = 'translateX(-50%) translateY(-4px)';
          clearTimeout(window.__toastTimer);
          window.__toastTimer = setTimeout(function () {
            try {
              existing.style.opacity = '0';
              existing.style.transform = 'translateX(-50%)';
            } catch (e) {}
          }, 2200);
        } catch (e) {}
      }

      if (myAtt) {
        var waitAttendances2 = (activity.attendances || []).filter(function(a){ return a && a.status === 'waitlist'; }).sort(function(a,b){ return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime(); });
        var waitIndex2 = (myAtt.status === 'waitlist') ? (waitAttendances2.findIndex(function(a){ return a.id === myAtt.id; }) + 1) : 0;
        try {
          var userStrX = localStorage.getItem(USER_KEY);
          var meX = userStrX ? JSON.parse(userStrX) : null;
          var key = 'team_management:lastStatus:' + (meX && meX.id ? meX.id : 'unknown') + ':' + activity.id;
          var prev = sessionStorage.getItem(key);
          var nowStatus = myAtt.status || 'registered';
          if (prev && prev !== 'waitlist' && nowStatus === 'waitlist') {
            showToast('ä½ å·²è¿›å…¥å€™è¡¥é˜Ÿåˆ—ï¼ˆç¬¬' + (waitIndex2 || '?') + 'ä½ï¼‰');
          }
          if (prev === 'waitlist' && nowStatus !== 'waitlist') {
            showToast('å¥½æ¶ˆæ¯ï¼šä½ å·²ä»å€™è¡¥è½¬ä¸ºå·²æŠ¥åï¼');
          }
          sessionStorage.setItem(key, nowStatus);
        } catch (e) {}
        var waitIndex2 = (myAtt.status === 'waitlist') ? (waitAttendances2.findIndex(function(a){ return a.id === myAtt.id; }) + 1) : 0;
        if (myAtt.status === 'waitlist') {
          statusEl.textContent = 'å€™è¡¥ä¸­' + (waitIndex2 ? (' Â· ç¬¬' + waitIndex2 + 'ä½') : '');
        } else {
          statusEl.textContent = (myAtt.position && myAtt.position.trim()) ? 'å·²æŠ¥å Â· ' + myAtt.position : 'å·²æŠ¥å';
        }
        statusEl.classList.remove('hidden');
        btnEl.classList.remove('hidden');
        btnEl.classList.remove('btn-primary');
        btnEl.classList.remove('btn-danger');
        btnEl.classList.add('btn-danger-soft');
        btnEl.textContent = (myAtt.status === 'waitlist') ? 'å–æ¶ˆå€™è¡¥' : 'å–æ¶ˆæŠ¥å';
        btnEl.onclick = async (e) => {
          e.preventDefault();
          if (!confirm('ç¡®å®šå–æ¶ˆï¼Ÿ')) return;
          btnEl.disabled = true;
          try {
            const r = await fetch('/activities/' + activity.id + '/register', {
              method: 'DELETE',
              headers: { Authorization: 'Bearer ' + token },
            });
            if (r.ok) loadWeekendActivity();
            else {
              const err = await r.json().catch(() => ({}));
              alert(err.message || 'å–æ¶ˆå¤±è´¥');
            }
          } finally {
            btnEl.disabled = false;
          }
        };
      } else {
        statusEl.classList.add('hidden');
        btnEl.classList.remove('hidden');
        btnEl.classList.remove('btn-danger');
        btnEl.classList.remove('btn-danger-soft');
        btnEl.classList.add('btn-primary');
        btnEl.textContent = 'æŠ¥å';
        btnEl.onclick = function (e) {
          e.preventDefault();
          e.stopPropagation();
          openRegisterModal(activity);
        };
      }
    } catch (e) {
      var weatherBg = document.getElementById('weekendCardWeatherBg');
      if (weatherBg) weatherBg.innerHTML = '';
      emptyEl.hidden = false;
      contentEl.hidden = true;
      emptyEl.classList.remove('hidden');
      contentEl.classList.add('hidden');
    }
  }

  async function loadAllActivities() {
    const emptyEl = document.getElementById('activitiesEmpty');
    const itemsEl = document.getElementById('activityItems');

    try {
      const res = await fetch('/activities', { headers: { Authorization: 'Bearer ' + token } });
      if (!res.ok) return;
      const activities = await res.json();
      const list = Array.isArray(activities) ? activities : [];

      emptyEl.classList.toggle('hidden', list.length > 0);
      itemsEl.classList.toggle('hidden', list.length === 0);
      itemsEl.innerHTML = '';

      list.forEach(a => {
        const badge = getDateBadge(a.date);
        var nameText = a.name || 'æœªå‘½åæ´»åŠ¨';
        nameText = nameText.length > 17 ? nameText.slice(0, 17) + 'â€¦' : nameText;
        var venueDisplay = getVenueDisplay(a);
        var venueText = (venueDisplay && venueDisplay.length > 15) ? venueDisplay.slice(0, 15) + 'â€¦' : (venueDisplay || 'â€”');
        var total = (a.maxParticipants != null && a.maxParticipants >= 1) ? a.maxParticipants : 14;
        var registeredCount = (a.registeredCount != null) ? a.registeredCount : ((a.attendances || []).filter(function(t){ return t && (t.status === 'registered' || t.status === 'present' || t.status === 'late'); }).length);
        var waitlistCount = (a.waitlistCount != null) ? a.waitlistCount : ((a.attendances || []).filter(function(t){ return t && t.status === 'waitlist'; }).length);
        var countText = registeredCount + '/' + total + 'äºº' + (waitlistCount > 0 ? (' Â· å€™è¡¥' + waitlistCount) : '');
        var registeredBadge = '';
        try {
          var me3 = null;
          var userStr3 = localStorage.getItem(USER_KEY);
          if (userStr3) me3 = JSON.parse(userStr3);
          if (me3 && a.attendances && a.attendances.length) {
            var myLite = a.attendances.find(function(t){ return t && t.userId === me3.id; }) || null;
            if (myLite) {
              if (myLite.status === 'waitlist') {
                registeredBadge = '<span class="registered-badge inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium" style="background: rgba(251,191,36,0.18); border-color: rgba(251,191,36,0.5); color: #fde68a;" aria-label="å€™è¡¥"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v6l4 2"/></svg>å€™è¡¥</span>';
              } else {
                registeredBadge = '<span class="registered-badge inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium" aria-label="å·²æŠ¥å"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>å·²æŠ¥å</span>';
              }
            }
          }
        } catch (e) {}
        var chip = getDayChip(a.date);
        var dayChip = '<div class="shrink-0 w-14 h-14 rounded-2xl flex flex-col items-center justify-center border border-white/10 bg-white/5">'
          + '<div class="text-white/70 text-[11px] font-semibold">' + (chip.wd || '') + '</div>'
          + '<div class="text-white text-lg font-black leading-none" style="margin-top:2px">' + (chip.d || '') + '</div>'
          + '<div class="text-white/55 text-[11px] font-semibold" style="margin-top:2px">' + (chip.m ? (chip.m + 'æœˆ') : '') + '</div>'
          + '</div>';

        const row = document.createElement('a');
        row.href = '/activities.html?id=' + (a.id || '');
        row.className = 'activity-row block';
        row.innerHTML =
          '<div class="body flex-1 min-w-0" style="display:flex; gap:14px; align-items:flex-start">' +
            dayChip +
            '<div class="min-w-0 flex-1">' +
              '<div class="name-row flex items-center gap-2 flex-wrap"><span class="name">' + escapeHtml(nameText) + '</span>' + registeredBadge + '</div>' +
              '<div class="meta">' + escapeHtml(venueText) + ' Â· ' + formatActivityDate(a.date) + ' Â· <span class="tabular-nums">' + countText + '</span></div>' +
            '</div>' +
          '</div>' +
          '<span class="arrow" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></span>';
        itemsEl.appendChild(row);
      });
    } catch (e) {
      emptyEl.classList.remove('hidden');
      itemsEl.classList.add('hidden');
    }
  }

  function setBottomNavActive() {
    const path = window.location.pathname;
    const key = path === '/dashboard.html' ? 'dashboard' : path === '/activities.html' ? 'activities' : path === '/profile.html' ? 'me' : 'dashboard';
    document.querySelectorAll('.bottom-nav-item').forEach(a => {
      a.classList.toggle('active', a.dataset.nav === key);
    });
  }

  var registerModalActivityId = null;
  var registerModalAttendances = [];

  function openRegisterModal(activity) {
    var overlay = document.getElementById('registerModalOverlay');
    var selectEl = document.getElementById('registerPositionSelect');
    var teamEl = document.getElementById('registerTeamSelect');
    if (!overlay || !selectEl || !teamEl) return;

    var activityId = activity && activity.id;
    var attendances = (activity && activity.attendances) || [];
    var maxParticipants = (activity && activity.maxParticipants != null) ? activity.maxParticipants : 14; // used for lineup gate (>=8)
    var teamCount = (activity && activity.teamCount != null) ? activity.teamCount : Math.ceil((maxParticipants || 1) / 12);
    if (teamCount < 1) teamCount = 1;
    if (teamCount > 4) teamCount = 4;
    var teamCap = Math.ceil((maxParticipants || 1) / teamCount);
    var teamNames = (activity && activity.teamNames && Array.isArray(activity.teamNames)) ? activity.teamNames : [];
    var defaultNames = teamCount === 1 ? ['é˜Ÿä¼'] : (teamCount === 2 ? ['çº¢é˜Ÿ','è“é˜Ÿ'] : (teamCount === 3 ? ['çº¢é˜Ÿ','è“é˜Ÿ','ç´«é˜Ÿ'] : ['çº¢é˜Ÿ','è“é˜Ÿ','ç´«é˜Ÿ','é»„é˜Ÿ']));
    while (teamNames.length < teamCount) teamNames.push(defaultNames[teamNames.length] || ('é˜Ÿä¼' + (teamNames.length + 1)));
    if (teamNames.length > teamCount) teamNames = teamNames.slice(0, teamCount);

    var regAttendances = attendances.filter(function(a){ return a && (a.status === 'registered' || a.status === 'present' || a.status === 'late'); });
    var teamCounts = {};
    for (var i = 1; i <= teamCount; i++) teamCounts[i] = 0;
    regAttendances.forEach(function(a){
      var tn = a.teamNo;
      if (tn == null) return;
      if (typeof tn !== 'number') tn = parseInt(String(tn), 10);
      if (tn >= 1 && tn <= teamCount) teamCounts[tn] = (teamCounts[tn] || 0) + 1;
    });

    teamEl.innerHTML = '';
    var opt0 = document.createElement('option');
    opt0.value = '0';
    opt0.textContent = 'æœªå®š';
    teamEl.appendChild(opt0);
    for (var t = 1; t <= teamCount; t++) {
      var opt = document.createElement('option');
      opt.value = String(t);
      var used = teamCounts[t] || 0;
      opt.textContent = (teamNames[t-1] || ('é˜Ÿä¼' + t)) + 'ï¼ˆ' + used + '/' + teamCap + 'ï¼‰' + (used >= teamCap ? ' å·²æ»¡' : '');
      teamEl.appendChild(opt);
    }
    teamEl.value = '0';

    registerModalActivityId = activityId;
    registerModalAttendances = attendances;

    if (typeof window.fillPositionSelect === 'function') {
      window.fillPositionSelect(selectEl, maxParticipants);
    }

    function refreshPositionOccupiedHints() {
      try {
        var tn2 = teamEl ? parseInt((teamEl.value || '0'), 10) : 0;
        if (!Number.isFinite(tn2) || tn2 < 0) tn2 = 0;

        var occupied = {};
        if (tn2 > 0) {
          regAttendances.forEach(function(a){
            if (!a || !a.position) return;
            var uid = a.user && a.user.id;
            if (currentUser && uid && currentUser.id && uid === currentUser.id) return;
            var atn = a.teamNo;
            if (atn == null) return;
            if (typeof atn !== 'number') atn = parseInt(String(atn), 10);
            if (atn !== tn2) return;
            var p = String(a.position).trim();
            if (p) occupied[p] = true;
          });
        }

        for (var j = 0; j < selectEl.options.length; j++) {
          var o = selectEl.options[j];
          var v = (o.value || '').trim();
          if (!v) continue;
          o.textContent = o.textContent.replace(/\s*Â·\s*å·²æœ‰äºº\s*$/, '');
          if (tn2 > 0 && occupied[v]) o.textContent = o.textContent + ' Â· å·²æœ‰äºº';
        }
      } catch (e) {}
    }
    refreshPositionOccupiedHints();
    try { teamEl.addEventListener('change', refreshPositionOccupiedHints); } catch (e) {}

    var me = null;
    try {
      var userStr = localStorage.getItem(USER_KEY);
      if (userStr) me = JSON.parse(userStr);
    } catch (e) {}
    var defaultPos = (me && me.playingPosition && String(me.playingPosition).trim()) ? String(me.playingPosition).trim() : '';
    selectEl.value = defaultPos || '';
    var hasOption = false;
    for (var k = 0; k < selectEl.options.length; k++) {
      if (selectEl.options[k].value === defaultPos) { hasOption = true; break; }
    }
    if (!hasOption && defaultPos) selectEl.value = '';

    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden', 'false');
  }

  function closeRegisterModal() {
    var overlay = document.getElementById('registerModalOverlay');
    if (overlay) {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden', 'true');
    }
    registerModalActivityId = null;
    registerModalAttendances = [];
  }

  (function bindRegisterModal() {
    var overlay = document.getElementById('registerModalOverlay');
    var cancelBtn = document.getElementById('registerModalCancel');
    var confirmBtn = document.getElementById('registerModalConfirm');
    var selectEl = document.getElementById('registerPositionSelect');
    if (cancelBtn) cancelBtn.addEventListener('click', closeRegisterModal);
    if (overlay) {
      overlay.addEventListener('click', function (e) {
        if (e.target === overlay) closeRegisterModal();
      });
    }
    if (confirmBtn && selectEl) {
      confirmBtn.addEventListener('click', async function () {
        if (!registerModalActivityId) { closeRegisterModal(); return; }
        var position = (selectEl.value || '').trim();
        var teamEl = document.getElementById('registerTeamSelect');
        var teamNo = teamEl ? parseInt((teamEl.value || '0'), 10) : 0;
        if (!Number.isFinite(teamNo) || teamNo < 0) teamNo = 0;

        // æœªå®šé˜Ÿä¼/æœªå®šä½ç½®ï¼šæé†’ç”¨æˆ·ï¼ˆé˜Ÿé•¿å¯èƒ½ä¼šæŒ‡å®šï¼‰
        if (teamNo === 0 || !position) {
          var msg = 'ä½ é€‰æ‹©äº†æœªå®šé˜Ÿä¼æˆ–æœªå®šä½ç½®ã€‚\n\né˜Ÿä¼å’Œä½ç½®å¯èƒ½ä¼šç”±é˜Ÿé•¿æŒ‡å®šã€‚\n\nä»ç„¶è¦æŠ¥åå—ï¼Ÿ';
          if (!confirm(msg)) return;
        }

        // åŒé˜Ÿä½ç½®é‡å¤æ ¡éªŒï¼ˆä¸è¯¦æƒ…é¡µä¸€è‡´ï¼šåªåœ¨é€‰æ‹©äº†é˜Ÿä¼æ—¶æ ¡éªŒï¼›å¹¶æ’é™¤è‡ªå·±ï¼‰
        if (position && teamNo > 0) {
          var hasSame = (registerModalAttendances || []).some(function (a) {
            if (!a) return false;
            var atn = a.teamNo;
            if (atn == null) return false;
            if (typeof atn !== 'number') atn = parseInt(String(atn), 10);
            if (atn !== teamNo) return false;
            var uid = a.user && a.user.id;
            if (currentUser && uid && currentUser.id && uid === currentUser.id) return false;
            return (a.position || '').trim() === position;
          });
          if (hasSame) {
            alert('åŒé˜Ÿä½ç½®é‡å¤äº†ï¼Œè¯·æ¢ä¸ªä½ç½®');
            return;
          }
        }

        confirmBtn.disabled = true;
        try {
          var body = {};
          if (position) body.position = position;
          if (Number.isFinite(teamNo) && teamNo >= 0) body.teamNo = teamNo;
          var r = await fetch('/activities/' + registerModalActivityId + '/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(body),
          });
          if (r.ok) {
            closeRegisterModal();
            loadWeekendActivity();
          } else {
            var err = await r.json().catch(function () { return {}; });
            alert(err.message || 'æŠ¥åå¤±è´¥');
          }
        } finally {
          confirmBtn.disabled = false;
        }
      });
    }
  })();

  (function bindWeekendCardClick() {
    var weekendCard = document.getElementById('weekendCard');
    var btnEl = document.getElementById('weekendRegisterBtn');
    if (!weekendCard) return;
    weekendCard.addEventListener('click', function (e) {
      if (btnEl && (e.target === btnEl || btnEl.contains(e.target))) return;
      var id = weekendCard.dataset.activityId;
      if (id) window.location.href = '/activities.html?id=' + id;
    });
  })();

  (function init() {
    setTimeout(function () {
      token = localStorage.getItem(TOKEN_KEY);
      // #region agent log
      (function(d){fetch('http://127.0.0.1:7242/ingest/f9c175ba-04d6-464f-bb6b-0d5e0ace1822',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).catch(function(){});})({location:'dashboard.html:init',message:'token read',data:{origin:window.location.origin,hasToken:!!token,tokenLen:token?token.length:0},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H4'});
      // #endregion
      if (!token) {
        requireLogin('æ—  tokenï¼ˆè¯·ç¡®ä¿ä»ç™»å½•é¡µè·³è½¬ä¸”æœªæ¸…é™¤ç¼“å­˜ï¼‰');
        return;
      }
      (async function () {
        await loadMe();
        loadWeekendActivity();
        loadAllActivities();
        setBottomNavActive();
      })();
    }, 0);
  })();
})();
  </script>
</body>
</html>
