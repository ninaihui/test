<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活动管理 - 业余球队管理系统</title>
    <link rel="stylesheet" href="/assets/app.css?v=20260130-1" />
    <style>
        body { margin: 0; min-height: 100vh; color: #e2e8f0; box-sizing: border-box;
            background: linear-gradient(180deg, rgba(0,8,24,.55) 0%, rgba(0,4,16,.72) 100%),
                url('/assets/login-bg.png') no-repeat center center fixed;
            background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; }
        .glass { background: rgba(0,0,0,.18); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,.12); }
        .glass input, .glass select, .glass textarea { background: rgba(0,0,0,.28); border: 1px solid rgba(255,255,255,.2); color: #e2e8f0; }
        .activity-list-item { border-bottom: 1px solid rgba(255,255,255,.08); }
        .activity-list-item:last-child { border-bottom: none; }
        .activity-list-item .nav-arrow { color: rgba(255,255,255,.4); display: inline-flex; align-items: center; gap: 0.25rem; transition: color .2s, transform .2s; }
        .activity-list-item a:hover .nav-arrow { color: rgba(255,255,255,.7); transform: translateX(2px); }
        .activity-list-item .nav-arrow svg { width: 1.125rem; height: 1.125rem; flex-shrink: 0; }
        .detail-nav-icon { width: 1.125rem; height: 1.125rem; flex-shrink: 0; }
        /* 创建活动弹窗：手机端固定高度，保证保存按钮始终在可视区 */
        @media (max-width: 640px) {
            .activity-modal-inner { height: 88vh; max-height: 88vh; }
            .activity-modal-footer {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }
        /* 报名弹窗：出场位置选择 */
        .register-modal-overlay { position: fixed; inset: 0; z-index: 60; background: rgba(0,0,0,.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; padding: 1rem; }
        .register-modal-overlay.show { display: flex; }
        .register-modal { width: 100%; max-width: 22rem; background: rgba(15,23,42,.95); border: 1px solid rgba(255,255,255,.15); border-radius: 1rem; padding: 1.25rem; box-shadow: 0 20px 40px rgba(0,0,0,.4); }
        .register-modal h3 { margin: 0 0 1rem; font-size: 1rem; font-weight: 600; color: #fff; }
        .register-modal .modal-select { width: 100%; padding: 0.625rem 0.75rem; border-radius: 0.5rem; font-size: 0.9375rem; color: #fff; background: rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,.2); margin-bottom: 1rem; }
        .register-modal .modal-select:focus { outline: none; border-color: rgba(34,197,94,.6); }
        .register-modal .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; }
        .register-modal .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; border: none; }
        .register-modal .btn-ghost { background: rgba(255,255,255,.1); color: #e2e8f0; }
        .register-modal .btn-ghost:hover { background: rgba(255,255,255,.15); }
        /* 已报名角标：与标题同行，不遮挡查看 */
        .registered-badge { white-space: nowrap; flex-shrink: 0; background: rgba(16,185,129,0.22); border: 1px solid rgba(16,185,129,0.5); color: #a7f3d0; }
        .registered-badge svg { width: 0.875rem; height: 0.875rem; flex-shrink: 0; }
    </style>
</head>
<body class="min-h-screen text-slate-100 safe-bottom-nav">
    <!-- 登出按钮已移除 -->
    <!-- 主内容：移动端优先，与 dashboard 统一 -->
    <div class="max-w-2xl mx-auto px-4 py-6">
        <header class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-xl font-bold text-white">活动</h1>
                <p class="text-white/60 text-sm">报名与管理活动</p>
            </div>
            <div id="createActivityWrap" class="hidden">
                <button type="button" onclick="showCreateActivityModal()" class="btn btn-primary gap-2 py-3 px-5 shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    创建活动
                </button>
            </div>
        </header>

        <!-- 活动列表 -->
        <section>
            <h2 class="text-white/80 text-sm font-medium mb-3">活动列表</h2>
            <div class="glass rounded-2xl overflow-hidden">
                <div id="activitiesList">
                    <div class="text-center py-12 text-white/50 text-sm px-4">
                        <p>暂无活动</p>
                        <p class="mt-2" id="activitiesEmptyHint">加载中…</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 底部导航（移动端） -->
    <nav class="bottom-nav" aria-label="底部导航">
        <div class="bottom-nav-inner">
            <a class="bottom-nav-item" data-nav="dashboard" href="/dashboard.html">首页</a>
            <a class="bottom-nav-item" data-nav="activities" href="/activities.html">活动</a>
            <a class="bottom-nav-item" data-nav="me" href="/profile.html">我的</a>
        </div>
    </nav>

    <!-- 报名弹窗：队伍 + 出场位置（与活动详情页保持一致） -->
    <div id="registerModalOverlay" class="register-modal-overlay" aria-hidden="true">
        <div class="register-modal" role="dialog" aria-labelledby="registerModalTitle" aria-modal="true">
            <h3 id="registerModalTitle">报名设置</h3>
            <select id="registerTeamSelect" class="modal-select" aria-label="队伍">
                <option value="0">未定</option>
            </select>
            <select id="registerPositionSelect" class="modal-select" aria-label="出场位置">
                <option value="">未选择</option>
                <optgroup label="守门员">
                    <option value="守门员">守门员 (GK)</option>
                </optgroup>
                <optgroup label="后卫">
                    <option value="中后卫">中后卫 (CB)</option>
                    <option value="右后卫">右后卫 (RB)</option>
                    <option value="左后卫">左后卫 (LB)</option>
                </optgroup>
                <optgroup label="中场">
                    <option value="后腰">后腰 (DM)</option>
                    <option value="中前卫">中前卫 (CM)</option>
                    <option value="前腰">前腰 (AM)</option>
                    <option value="右前卫">右前卫 (RM)</option>
                    <option value="左前卫">左前卫 (LM)</option>
                    <option value="右边锋">右边锋 (RW)</option>
                    <option value="左边锋">左边锋 (LW)</option>
                </optgroup>
                <optgroup label="前锋">
                    <option value="影锋">影锋 (SS)</option>
                    <option value="中锋">中锋 (CF)</option>
                    <option value="前锋">前锋 (ST)</option>
                </optgroup>
            </select>
            <div class="modal-actions">
                <button type="button" id="registerModalCancel" class="btn btn-ghost">取消</button>
                <button type="button" id="registerModalConfirm" class="btn btn-primary">确定报名</button>
            </div>
        </div>
    </div>

    <!-- 活动详情弹窗：标题固定，内容区可纵向滚动 -->
    <div id="activityDetailModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl max-w-lg w-full max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-4 pb-2 shrink-0">
                <h3 class="text-lg font-bold text-white">活动详情</h3>
                <button type="button" onclick="closeActivityDetailModal()" class="w-9 h-9 rounded-full flex items-center justify-center text-white/70 hover:text-white bg-white/10 hover:bg-white/20 transition" aria-label="关闭">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="activityDetailContent" class="space-y-4 overflow-y-auto overflow-x-hidden flex-1 min-h-0 px-4 pb-4 overscroll-contain" style="-webkit-overflow-scrolling: touch;">
                <div class="text-center py-8 text-white/50 text-sm">加载中…</div>
            </div>
        </div>
    </div>

    <!-- 创建/编辑活动模态框：手机端固定高度+可滚动内容，保存按钮始终贴底可见 -->
    <div id="activityModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 safe-area-pb">
        <div class="activity-modal-inner glass rounded-t-2xl sm:rounded-2xl w-full max-w-md flex flex-col shadow-xl sm:max-h-[90vh]">
            <div class="flex justify-between items-center p-4 sm:p-6 pb-2 shrink-0">
                <h3 class="text-xl sm:text-2xl font-bold text-white" id="modalTitle">创建活动</h3>
                <button type="button" onclick="closeActivityModal()" class="w-10 h-10 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition" aria-label="关闭">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="activityForm" class="flex flex-col flex-1 min-h-0 overflow-hidden">
                <div class="overflow-y-auto overflow-x-hidden px-4 sm:p-6 pt-0 space-y-4 flex-1 min-h-0 overscroll-contain">
                    <div>
                        <label class="block text-white/80 mb-2">活动名字</label>
                        <input type="text" id="activityName" required placeholder="例如：周末踢球"
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">活动日期</label>
                        <input type="date" id="activityDate" required 
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">活动时间</label>
                        <input type="time" id="activityTime" required 
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">活动地点</label>
                        <input type="text" id="activityLocation" required placeholder="输入场地名称或地址，或从地图选好后粘贴"
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                        <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-1">
                            <a id="activityMapLink" href="https://www.google.com/maps" target="_blank" rel="noopener noreferrer" class="text-sm text-cyan-400/90 hover:underline">在 Google 地图中选位置</a>
                            <span id="activityMapHint" class="text-white/50 text-xs">选好位置后，将地址复制回上方输入框</span>
                        </div>
                        <div class="mt-2 rounded-xl overflow-hidden border border-white/10 bg-black/20" id="activityMapWrap" style="display: none;">
                            <iframe id="activityMapEmbed" title="Google 地图" width="100%" height="200" style="border:0;" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">活动人数上限</label>
                        <input type="number" id="activityMaxParticipants" min="1" max="40" value="24" required
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400/50"
                            placeholder="24">
                        <p class="text-white/50 text-xs mt-1">最少 1 人，最多 40 人。<span class="text-white/60">当人数上限 &lt; 8 时：不会展示【阵容】按钮，也无需管理位置。</span></p>
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">分队数 <span class="text-white/40 text-sm">（可选）</span></label>
                        <input type="number" id="activityTeamCount" min="1" max="4" placeholder="留空=自动" 
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-white/35 focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                        <p class="text-white/50 text-xs mt-1">默认算法：teamCount = ceil(人数上限/12)，最多 4 队</p>
                    </div>
                    <div id="teamNamesWrap">
                        <label class="block text-white/80 mb-2">队伍名称 <span class="text-white/40 text-sm">（可编辑）</span></label>
                        <div id="teamNamesInputs" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                        <p class="text-white/50 text-xs mt-1">默认：红队 / 蓝队 / 紫队 / 黄队</p>
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">活动描述 <span class="text-white/40 text-sm">（选填）</span></label>
                        <textarea id="activityDescription" rows="2" placeholder="可选备注"
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 resize-none"></textarea>
                    </div>
                </div>
                <div class="activity-modal-footer p-4 sm:p-6 pt-4 shrink-0 border-t border-white/10 bg-black/20 sm:bg-transparent sm:border-t-0">
                    <div id="activityError" class="hidden rounded-xl px-4 py-3 text-sm text-red-200 bg-red-500/15 border border-red-500/40 mb-3"></div>
                    <button type="submit" id="activitySubmitBtn" class="btn btn-primary w-full py-3.5 text-base font-semibold gap-2 shadow-lg shadow-cyan-500/25 active:scale-[0.98]">
                        <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                        创建
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 炫酷背景效果 -->
    <script src="/js/fancy-background.js"></script>
    <script src="/js/position-options.js"></script>
    <script>
        const authToken = (localStorage.getItem('authToken') || sessionStorage.getItem('authToken'));
        const LAST_LOCATION_KEY = 'team_management:lastActivityLocation';
        const LAST_ACTIVITY_NAME_KEY = 'team_management:lastActivityName';
        var currentUser = null;
        try {
            var u = localStorage.getItem('user');
            if (u) currentUser = JSON.parse(u);
        } catch (e) {}
        function canCreateActivity() {
            return currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin');
        }
        function canDeleteActivity(activity) {
            return currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin');
        }
        if (!authToken) {
            window.location.href = '/login.html';
        }

        function logout() {
            localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        /** 取当前周的周六（若今天是周六则取今天） */
        function getThisWeekSaturday() {
            var d = new Date();
            var day = d.getDay();
            var daysToSat = (6 - day + 7) % 7;
            d.setDate(d.getDate() + daysToSat);
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        function renderTeamNameInputs(count) {
            var wrap = document.getElementById('teamNamesInputs');
            if (!wrap) return;
            wrap.innerHTML = '';
            var defaults = (function(){
                if (count === 1) return ['队伍'];
                if (count === 2) return ['红队', '蓝队'];
                if (count === 3) return ['红队', '蓝队', '紫队'];
                return ['红队', '蓝队', '紫队', '黄队'];
            })();
            for (var i = 0; i < count; i++) {
                var input = document.createElement('input');
                input.type = 'text';
                input.setAttribute('data-team-name', '1');
                input.className = 'w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-white/35 focus:outline-none focus:ring-2 focus:ring-cyan-400/50';
                input.placeholder = '队伍' + (i + 1);
                input.value = defaults[i] || ('队伍' + (i + 1));
                wrap.appendChild(input);
            }
        }
        function computeDefaultTeamCount(mp) {
            var c = Math.ceil((mp || 1) / 12);
            if (c < 1) c = 1;
            if (c > 4) c = 4;
            return c;
        }

        function showCreateActivityModal() {
            document.getElementById('modalTitle').textContent = '创建活动';
            var btn = document.getElementById('activitySubmitBtn');
            if (btn) btn.lastChild.textContent = '创建';
            document.getElementById('activityForm').reset();
            document.getElementById('activityError').classList.add('hidden');

            // default name = last created name (fallback 周末踢球)
            var nameEl = document.getElementById('activityName');
            if (nameEl) {
                var lastName = localStorage.getItem(LAST_ACTIVITY_NAME_KEY);
                nameEl.value = (lastName && lastName.trim()) ? lastName.trim() : '周末踢球';
            }

            document.getElementById('activityDate').value = getThisWeekSaturday();
            var maxEl = document.getElementById('activityMaxParticipants');
            if (maxEl) maxEl.value = '24';
            document.getElementById('activityTime').value = '19:00';
            var teamCountEl = document.getElementById('activityTeamCount');
            if (teamCountEl) teamCountEl.value = '';
            renderTeamNameInputs(computeDefaultTeamCount(24));
            var locInput = document.getElementById('activityLocation');
            var lastLoc = localStorage.getItem(LAST_LOCATION_KEY);
            if (lastLoc && lastLoc.trim()) {
                locInput.value = lastLoc.trim();
                locInput.dispatchEvent(new Event('input', { bubbles: true }));
            } else {
                document.getElementById('activityMapLink').href = 'https://www.google.com/maps';
                document.getElementById('activityMapLink').textContent = '在 Google 地图中选位置';
                document.getElementById('activityMapWrap').style.display = 'none';
            }
            document.getElementById('activityModal').classList.remove('hidden');
        }

        // Update default team count + names when maxParticipants changes (only when teamCount is empty)
        (function bindTeamCountAuto() {
            var maxEl = document.getElementById('activityMaxParticipants');
            var teamCountEl = document.getElementById('activityTeamCount');
            if (!maxEl || !teamCountEl) return;
            function refresh() {
                var mp = parseInt(maxEl.value || '1', 10);
                if (!mp || mp < 1) mp = 1;
                if (mp > 40) mp = 40;
                var tcVal = (teamCountEl.value || '').trim();
                var tc = tcVal ? parseInt(tcVal, 10) : null;
                var eff = (tc && tc >= 1 && tc <= 4) ? tc : computeDefaultTeamCount(mp);
                renderTeamNameInputs(eff);
            }
            maxEl.addEventListener('change', refresh);
            maxEl.addEventListener('input', function(){ if (!teamCountEl.value) refresh(); });
            teamCountEl.addEventListener('change', refresh);
        })();

        document.getElementById('activityLocation').addEventListener('input', function() {
            var loc = this.value.trim();
            var linkEl = document.getElementById('activityMapLink');
            var wrapEl = document.getElementById('activityMapWrap');
            var iframeEl = document.getElementById('activityMapEmbed');
            if (loc) {
                linkEl.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(loc);
                linkEl.textContent = '在 Google 地图中查看';
                iframeEl.src = 'https://www.google.com/maps?q=' + encodeURIComponent(loc) + '&output=embed';
                wrapEl.style.display = 'block';
            } else {
                linkEl.href = 'https://www.google.com/maps';
                linkEl.textContent = '在 Google 地图中选位置';
                wrapEl.style.display = 'none';
                iframeEl.src = '';
            }
        });

        function closeActivityModal() {
            document.getElementById('activityModal').classList.add('hidden');
        }

        document.getElementById('activityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const errorEl = document.getElementById('activityError');
            const btn = document.getElementById('activitySubmitBtn');
            errorEl.classList.add('hidden');

            const name = (document.getElementById('activityName') && document.getElementById('activityName').value) ? document.getElementById('activityName').value.trim() : '';
            const activityDate = document.getElementById('activityDate').value;
            const activityTime = document.getElementById('activityTime').value;
            const location = document.getElementById('activityLocation').value.trim();
            const description = document.getElementById('activityDescription').value.trim() || undefined;
            var maxParticipants = 24;
            var maxEl = document.getElementById('activityMaxParticipants');
            if (maxEl && maxEl.value !== '') {
                var n = parseInt(maxEl.value, 10);
                if (n >= 1 && n <= 40) maxParticipants = n;
                else if (n < 1) { maxParticipants = 1; if (maxEl) maxEl.value = '1'; }
                else if (n > 40) { maxParticipants = 40; if (maxEl) maxEl.value = '40'; }
            }

            function computeDefaultTeamCount(mp) {
                var c = Math.ceil((mp || 1) / 12);
                if (c < 1) c = 1;
                if (c > 4) c = 4;
                return c;
            }
            var teamCountEl = document.getElementById('activityTeamCount');
            var teamCount = null;
            if (teamCountEl && teamCountEl.value !== '') {
                var tc = parseInt(teamCountEl.value, 10);
                if (tc >= 1 && tc <= 4) teamCount = tc;
            }
            var effectiveTeamCount = teamCount || computeDefaultTeamCount(maxParticipants);

            function defaultTeamNames(count) {
                if (count === 1) return ['队伍'];
                if (count === 2) return ['红队', '蓝队'];
                if (count === 3) return ['红队', '蓝队', '紫队'];
                return ['红队', '蓝队', '紫队', '黄队'];
            }
            var names = [];
            var namesWrap = document.getElementById('teamNamesInputs');
            if (namesWrap) {
                var inputs = namesWrap.querySelectorAll('input[data-team-name]');
                inputs.forEach(function(inp){
                    var v = (inp.value || '').trim();
                    if (v) names.push(v);
                });
            }
            var defaults = defaultTeamNames(effectiveTeamCount);
            while (names.length < effectiveTeamCount) names.push(defaults[names.length] || ('队伍' + (names.length + 1)));
            if (names.length > effectiveTeamCount) names = names.slice(0, effectiveTeamCount);

            if (!name || !activityDate || !activityTime || !location) {
                errorEl.textContent = '请填写活动名字、日期、时间和地点';
                errorEl.classList.remove('hidden');
                return;
            }

            const dateStr = activityDate + 'T' + activityTime + ':00';

            btn.disabled = true;
            try {
                const res = await fetch('/activities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken,
                    },
                    body: JSON.stringify({
                        name,
                        date: dateStr,
                        location: location || undefined,
                        description,
                        maxParticipants,
                        teamCount: teamCount || undefined,
                        teamNames: names,
                    }),
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok) {
                    localStorage.setItem(LAST_LOCATION_KEY, location);
                    localStorage.setItem(LAST_ACTIVITY_NAME_KEY, name);
                    closeActivityModal();
                    loadActivities();
                } else {
                    errorEl.textContent = data.message || '创建失败（' + res.status + '）';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                errorEl.textContent = err.message || '网络错误，请稍后重试';
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        });

        function getVenueDisplay(activity) {
            if (activity.venue && activity.venue.name) return activity.venue.name;
            return activity.location || '—';
        }

        function formatActivityDate(iso) {
            if (!iso) return '—';
            const d = new Date(iso);
            var datePart = (d.getMonth() + 1) + '月' + d.getDate() + '号';
            var timePart = d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            return datePart + ' ' + timePart;
        }
        function formatDateTimeLocal(iso) {
            if (!iso) return '';
            var d = new Date(iso);
            var y = d.getFullYear();
            var m = String(d.getMonth() + 1).padStart(2, '0');
            var day = String(d.getDate()).padStart(2, '0');
            var h = String(d.getHours()).padStart(2, '0');
            var min = String(d.getMinutes()).padStart(2, '0');
            return y + '-' + m + '-' + day + 'T' + h + ':' + min;
        }

        async function loadActivities() {
            const listEl = document.getElementById('activitiesList');
            try {
                const res = await fetch('/activities', {
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                const activities = await res.json();
                const list = Array.isArray(activities) ? activities : [];
                if (list.length === 0) {
                    var emptyHint = canCreateActivity() ? '点击右上角「创建活动」开始' : '请联系管理员创建活动';
                    listEl.innerHTML = '<div class="text-center py-12 text-white/50 text-sm px-4"><p>暂无活动</p><p class="mt-2">' + emptyHint + '</p></div>';
                    return;
                }
                listEl.innerHTML = list.map(function(a) {
                    var nameText = a.name || '未命名';
                    nameText = nameText.length > 17 ? nameText.slice(0, 17) + '…' : nameText;
                    var venueDisplay = getVenueDisplay(a);
                    var venueText = (venueDisplay && venueDisplay.length > 15) ? venueDisplay.slice(0, 15) + '…' : (venueDisplay || '—');
                    var nameEsc = (nameText || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    var venueEsc = (venueText || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    var canDel = canDeleteActivity(a);
                    var total = (a.maxParticipants != null && a.maxParticipants >= 1) ? a.maxParticipants : 14; // used for lineup gate (>=8)
                    var registeredCount = (a.registeredCount != null) ? a.registeredCount : ((a._count && a._count.attendances != null) ? a._count.attendances : (a.attendances ? a.attendances.length : 0));
                    var waitlistCount = (a.waitlistCount != null) ? a.waitlistCount : 0;
                    var countText = registeredCount + '/' + total + '人' + (waitlistCount > 0 ? (' · 候补' + waitlistCount) : '');
                    var myAttLite = null;
                    try {
                        var me2 = currentUser || null;
                        if (!me2) { var u2 = localStorage.getItem('user'); if (u2) me2 = JSON.parse(u2); }
                        if (me2 && a.attendances && a.attendances.length) {
                            myAttLite = a.attendances.find(function(t){ return t && t.userId === me2.id; }) || null;
                        }
                    } catch (e) {}
                    var registeredBadge = '';
                    if (myAttLite) {
                        if (myAttLite.status === 'waitlist') {
                            registeredBadge = '<span class="registered-badge inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium" style="background: rgba(251,191,36,0.18); border-color: rgba(251,191,36,0.5); color: #fde68a;" aria-label="候补"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v6l4 2"/></svg>候补</span>';
                        } else {
                            registeredBadge = '<span class="registered-badge inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium" aria-label="已报名"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>已报名</span>';
                        }
                    }
                    var isFull = (registeredCount >= total);
                    var fullBadge = isFull ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-white/10 text-white/70">已满</span>' : '';
                    var row = '<div class="activity-list-item flex justify-between items-center gap-2 py-4 px-4 hover:bg-white/5 transition">' +
                        '<a href="/activity-detail.html?activityId=' + (a.id || '') + '" class="min-w-0 flex-1 flex items-center gap-4">' +
                        '<div class="min-w-0 flex-1"><div class="flex items-center gap-2 flex-wrap"><span class="text-white font-medium min-w-0">' + nameEsc + '</span>' + registeredBadge + fullBadge + '</div>' +
                        '<div class="text-white/60 text-sm mt-0.5">' + venueEsc + ' · ' + formatActivityDate(a.date) + ' · <span class="tabular-nums">' + countText + '</span></div></div>' +
                        '<span class="nav-arrow text-sm shrink-0"><span>查看</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 18l6-6-6-6"/></svg></span></a>';
                    if (canDel) {
                        row += '<button type="button" class="btn btn-danger btn-sm shrink-0" data-activity-id="' + (a.id || '') + '" aria-label="删除活动">删除</button>';
                    }
                    row += '</div>';
                    return row;
                }).join('');
                listEl.querySelectorAll('[data-activity-id]').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var id = btn.getAttribute('data-activity-id');
                        if (id) deleteActivity(id);
                    });
                });
            } catch (err) {
                listEl.innerHTML = '<div class="text-center py-12 text-red-300 text-sm">加载失败，请刷新重试</div>';
            }
        }

        function closeActivityDetailModal() {
            document.getElementById('activityDetailModal').classList.add('hidden');
            if (window.history && window.history.replaceState) {
                var url = new URL(window.location.href);
                url.searchParams.delete('id');
                window.history.replaceState({}, '', url.pathname + (url.search || ''));
            }
        }

        async function deleteActivity(id) {
            if (!id || !confirm('确定删除该活动？删除后报名记录也会被清除。')) return;
            try {
                var res = await fetch('/activities/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.ok) {
                    closeActivityDetailModal();
                    loadActivities();
                } else {
                    var err = await res.json().catch(function() { return {}; });
                    alert(err.message || '删除失败');
                }
            } catch (e) {
                alert('网络错误，请重试');
            }
        }

        async function registerActivity(id, teamNo, position) {
            if (!id) return false;
            try {
                var body = {};
                if (position && position.trim()) body.position = position.trim();
                if (Number.isFinite(teamNo) && teamNo >= 0) body.teamNo = teamNo;
                var res = await fetch('/activities/' + id + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify(body),
                });
                if (res.ok) { openActivityDetail(id); return true; }
                var err = await res.json().catch(function() { return {}; });
                alert(err.message || '报名失败');
                return false;
            } catch (e) {
                alert('网络错误，请重试');
                return false;
            }
        }

        var registerModalActivityId = null;
        var registerModalAttendances = [];

        function openRegisterModal(activity) {
            var overlay = document.getElementById('registerModalOverlay');
            var selectEl = document.getElementById('registerPositionSelect');
            var teamEl = document.getElementById('registerTeamSelect');
            if (!overlay || !selectEl || !teamEl) return;

            var activityId = activity && activity.id;
            var attendances = (activity && activity.attendances) || [];
            var maxParticipants = (activity && activity.maxParticipants != null) ? activity.maxParticipants : 14; // used for lineup gate (>=8)
            var teamCount = (activity && activity.teamCount != null) ? activity.teamCount : Math.ceil((maxParticipants || 1) / 12);
            if (teamCount < 1) teamCount = 1;
            if (teamCount > 4) teamCount = 4;
            var teamCap = Math.ceil((maxParticipants || 1) / teamCount);
            var teamNames = (activity && activity.teamNames && Array.isArray(activity.teamNames)) ? activity.teamNames : [];
            var defaultNames = teamCount === 1 ? ['队伍'] : (teamCount === 2 ? ['红队','蓝队'] : (teamCount === 3 ? ['红队','蓝队','紫队'] : ['红队','蓝队','紫队','黄队']));
            while (teamNames.length < teamCount) teamNames.push(defaultNames[teamNames.length] || ('队伍' + (teamNames.length + 1)));
            if (teamNames.length > teamCount) teamNames = teamNames.slice(0, teamCount);

            // counts (registered only)
            var regAttendances = attendances.filter(function(a){ return a && (a.status === 'registered' || a.status === 'present' || a.status === 'late'); });
            var teamCounts = {};
            for (var i = 1; i <= teamCount; i++) teamCounts[i] = 0;
            regAttendances.forEach(function(a){
                var tn = a.teamNo;
                if (tn == null) return;
                if (typeof tn !== 'number') tn = parseInt(String(tn), 10);
                if (tn >= 1 && tn <= teamCount) teamCounts[tn] = (teamCounts[tn] || 0) + 1;
            });

            // render team select
            teamEl.innerHTML = '';
            var opt0 = document.createElement('option');
            opt0.value = '0';
            opt0.textContent = '未定';
            teamEl.appendChild(opt0);
            for (var t = 1; t <= teamCount; t++) {
                var opt = document.createElement('option');
                opt.value = String(t);
                var used = teamCounts[t] || 0;
                opt.textContent = (teamNames[t-1] || ('队伍' + t)) + '（' + used + '/' + teamCap + '）' + (used >= teamCap ? ' 已满' : '');
                teamEl.appendChild(opt);
            }
            teamEl.value = '0';

            registerModalActivityId = activityId;
            registerModalAttendances = attendances;

            if (typeof window.fillPositionSelect === 'function') {
                window.fillPositionSelect(selectEl, maxParticipants);
            }

            function refreshPositionOccupiedHints() {
                try {
                    var tn2 = teamEl ? parseInt((teamEl.value || '0'), 10) : 0;
                    if (!Number.isFinite(tn2) || tn2 < 0) tn2 = 0;

                    var occupied = {};
                    if (tn2 > 0) {
                        regAttendances.forEach(function(a){
                            if (!a || !a.position) return;
                            var uid = a.user && a.user.id;
                            if (currentUser && uid && currentUser.id && uid === currentUser.id) return; // exclude myself
                            var atn = a.teamNo;
                            if (atn == null) return;
                            if (typeof atn !== 'number') atn = parseInt(String(atn), 10);
                            if (atn !== tn2) return;
                            var p = String(a.position).trim();
                            if (p) occupied[p] = true;
                        });
                    }

                    for (var j = 0; j < selectEl.options.length; j++) {
                        var opt = selectEl.options[j];
                        var v = (opt.value || '').trim();
                        if (!v) continue;
                        opt.textContent = opt.textContent.replace(/\s*·\s*已有人\s*$/, '');
                        if (tn2 > 0 && occupied[v]) {
                            opt.textContent = opt.textContent + ' · 已有人';
                        }
                    }
                } catch (e) {}
            }
            refreshPositionOccupiedHints();
            try { teamEl.addEventListener('change', refreshPositionOccupiedHints); } catch (e) {}

            var me = currentUser || null;
            try {
                var userStr = localStorage.getItem('user');
                if (userStr && !me) me = JSON.parse(userStr);
            } catch (e) {}
            var defaultPos = (me && me.playingPosition && String(me.playingPosition).trim()) ? String(me.playingPosition).trim() : '';
            selectEl.value = defaultPos || '';
            var hasOption = false;
            for (var k = 0; k < selectEl.options.length; k++) {
                if (selectEl.options[k].value === defaultPos) { hasOption = true; break; }
            }
            if (!hasOption && defaultPos) selectEl.value = '';

            overlay.classList.add('show');
            overlay.setAttribute('aria-hidden', 'false');
        }

        function closeRegisterModal() {
            var overlay = document.getElementById('registerModalOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                overlay.setAttribute('aria-hidden', 'true');
            }
            registerModalActivityId = null;
            registerModalAttendances = [];
        }

        (function bindRegisterModal() {
            var overlay = document.getElementById('registerModalOverlay');
            var cancelBtn = document.getElementById('registerModalCancel');
            var confirmBtn = document.getElementById('registerModalConfirm');
            var selectEl = document.getElementById('registerPositionSelect');
            if (cancelBtn) cancelBtn.addEventListener('click', closeRegisterModal);
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) closeRegisterModal();
                });
            }
            if (confirmBtn && selectEl) {
                confirmBtn.addEventListener('click', async function() {
                    if (!registerModalActivityId) { closeRegisterModal(); return; }
                    var position = (selectEl.value || '').trim();
                    var teamEl = document.getElementById('registerTeamSelect');
                    var teamNo = teamEl ? parseInt((teamEl.value || '0'), 10) : 0;
                    if (!Number.isFinite(teamNo) || teamNo < 0) teamNo = 0;

                    // 未定队伍/未定位置：提醒用户（队长可能会指定）
                    if (teamNo === 0 || !position) {
                        var msg = '你选择了未定队伍或未定位置。\n\n队伍和位置可能会由队长指定。\n\n仍然要报名吗？';
                        if (!confirm(msg)) return;
                    }

                    // 同队位置重复校验（与详情页一致：只在选择了队伍时校验；并排除自己）
                    if (position && teamNo > 0) {
                        var hasSame = (registerModalAttendances || []).some(function(a) {
                            if (!a) return false;
                            var atn = a.teamNo;
                            if (atn == null) return false;
                            if (typeof atn !== 'number') atn = parseInt(String(atn), 10);
                            if (atn !== teamNo) return false;
                            var uid = a.user && a.user.id;
                            if (currentUser && uid && currentUser.id && uid === currentUser.id) return false;
                            return (a.position || '').trim() === position;
                        });
                        if (hasSame) {
                            alert('同队位置重复了，请换个位置');
                            return;
                        }
                    }

                    confirmBtn.disabled = true;
                    try {
                        var ok = await registerActivity(registerModalActivityId, teamNo, position);
                        if (ok) closeRegisterModal();
                    } catch (e) {
                        alert('网络错误，请重试');
                    } finally {
                        confirmBtn.disabled = false;
                    }
                });
            }
        })();

        async function unregisterActivity(id) {
            if (!id || !confirm('确定取消报名？')) return;
            try {
                var res = await fetch('/activities/' + id + '/register', {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.ok) openActivityDetail(id);
                else {
                    var err = await res.json().catch(function() { return {}; });
                    alert(err.message || '取消失败');
                }
            } catch (e) {
                alert('网络错误，请重试');
            }
        }

        function showToast(message) {
            try {
                var existing = document.getElementById('toast');
                if (!existing) {
                    existing = document.createElement('div');
                    existing.id = 'toast';
                    existing.style.position = 'fixed';
                    existing.style.left = '50%';
                    existing.style.bottom = 'calc(80px + env(safe-area-inset-bottom))';
                    existing.style.transform = 'translateX(-50%)';
                    existing.style.zIndex = '200';
                    existing.style.maxWidth = '92vw';
                    existing.style.padding = '10px 12px';
                    existing.style.borderRadius = '999px';
                    existing.style.background = 'rgba(15,23,42,0.95)';
                    existing.style.border = '1px solid rgba(255,255,255,0.18)';
                    existing.style.boxShadow = '0 12px 28px rgba(0,0,0,0.35)';
                    existing.style.color = '#e2e8f0';
                    existing.style.fontSize = '14px';
                    existing.style.opacity = '0';
                    existing.style.transition = 'opacity .15s ease, transform .15s ease';
                    document.body.appendChild(existing);
                }
                existing.textContent = message;
                existing.style.opacity = '1';
                existing.style.transform = 'translateX(-50%) translateY(-4px)';
                clearTimeout(window.__toastTimer);
                window.__toastTimer = setTimeout(function () {
                    try {
                        existing.style.opacity = '0';
                        existing.style.transform = 'translateX(-50%)';
                    } catch (e) {}
                }, 2200);
            } catch (e) {}
        }

        function maybeNotifyWaitlistOrPromotion(activityId, userId, myAtt, waitIndex) {
            try {
                if (!activityId || !userId || !myAtt) return;
                var key = 'team_management:lastStatus:' + userId + ':' + activityId;
                var prev = sessionStorage.getItem(key);
                var nowStatus = myAtt.status || 'registered';
                if (prev && prev !== 'waitlist' && nowStatus === 'waitlist') {
                    showToast('你已进入候补队列（第' + (waitIndex || '?') + '位）');
                }
                if (prev === 'waitlist' && nowStatus !== 'waitlist') {
                    showToast('好消息：你已从候补转为已报名！');
                }
                sessionStorage.setItem(key, nowStatus);
            } catch (e) {}
        }

        async function openActivityDetail(id) {
            var modal = document.getElementById('activityDetailModal');
            var content = document.getElementById('activityDetailContent');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="text-center py-8 text-white/50 text-sm">加载中…</div>';
            try {
                var res = await fetch('/activities/' + id, { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!res.ok) {
                    content.innerHTML = '<div class="text-center py-8 text-red-300 text-sm">加载失败</div>';
                    return;
                }
                var activity = await res.json();
                var venueDisplay = getVenueDisplay(activity);
                var canEdit = canDeleteActivity(activity);
                var displayName = (activity.name || '未命名').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                var titleHtml = canEdit
                    ? '<div class="flex items-center justify-between gap-2 flex-wrap"><span class="text-white font-semibold text-lg" id="activityDetailName">' + displayName + '</span><button type="button" class="btn btn-ghost btn-sm shrink-0" id="activityDetailEditNameBtn" data-activity-id="' + (activity.id || '') + '">编辑名称</button></div>'
                    : '<div class="text-white font-semibold text-lg" id="activityDetailName">' + displayName + '</div>';
                var venueEscapedForRow = (venueDisplay || '—').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                var dateDisplay = formatActivityDate(activity.date);
                var venueRowHtml = canEdit
                    ? '<div class="flex items-center justify-between gap-2 flex-wrap"><span class="text-white/70 text-sm" id="activityDetailVenue">' + venueEscapedForRow + '</span><button type="button" class="btn btn-ghost btn-sm shrink-0" id="activityDetailEditVenueBtn" data-activity-id="' + (activity.id || '') + '">编辑地点</button></div>'
                    : '<div class="text-white/70 text-sm" id="activityDetailVenue">' + venueEscapedForRow + '</div>';
                var dateRowHtml = canEdit
                    ? '<div class="flex items-center justify-between gap-2 flex-wrap"><span class="text-white/60 text-sm" id="activityDetailDate">' + dateDisplay + '</span><button type="button" class="btn btn-ghost btn-sm shrink-0" id="activityDetailEditDateBtn" data-activity-id="' + (activity.id || '') + '">编辑时间</button></div>'
                    : '<div class="text-white/60 text-sm" id="activityDetailDate">' + dateDisplay + '</div>';
                var html = titleHtml + venueRowHtml + dateRowHtml;
                if (venueDisplay && venueDisplay !== '—') {
                    var mapQuery = encodeURIComponent(venueDisplay);
                    var navUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + mapQuery;
                    var venueEscaped = (venueDisplay || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    var locationSvg = '<svg class="detail-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>';
                    html += '<div class="pt-3"><div class="text-white/70 text-sm mb-2">地点：' + venueEscaped + '</div><a href="' + navUrl + '" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 py-2 px-3 rounded-xl bg-white/10 border border-white/15 text-cyan-400/90 hover:bg-white/15 hover:text-cyan-400 text-sm font-medium transition">' + locationSvg + ' 定位 · 点击导航至此处</a></div>';
                }
                if (activity.description && activity.description.trim()) {
                    html += '<div class="text-white/60 text-sm pt-2 border-t border-white/10">' + activity.description.trim() + '</div>';
                }
                var attendances = activity.attendances || [];
                var myAtt = currentUser ? (attendances.find(function(a) { return a.user && a.user.id === currentUser.id; }) || null) : null;
                var totalSlots = (activity.maxParticipants != null && activity.maxParticipants >= 1) ? activity.maxParticipants : 11;
                var regAttendances = attendances.filter(function(a){ return a && (a.status === 'registered' || a.status === 'present' || a.status === 'late'); });
                var waitAttendances = attendances.filter(function(a){ return a && a.status === 'waitlist'; }).sort(function(a,b){ return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime(); });
                var waitIndex = (myAtt && myAtt.status === 'waitlist') ? (waitAttendances.findIndex(function(a){ return a.id === myAtt.id; }) + 1) : 0;
                if (myAtt && currentUser && currentUser.id) maybeNotifyWaitlistOrPromotion(activity.id || '', currentUser.id, myAtt, waitIndex);
                var totalSlots = (activity.maxParticipants != null && activity.maxParticipants >= 1) ? activity.maxParticipants : 11;
                var regAttendances = attendances.filter(function(a){ return a && (a.status === 'registered' || a.status === 'present' || a.status === 'late'); });
                var waitAttendances = attendances.filter(function(a){ return a && a.status === 'waitlist'; }).sort(function(a,b){ return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime(); });
                var waitIndex = (myAtt && myAtt.status === 'waitlist') ? (waitAttendances.findIndex(function(a){ return a.id === myAtt.id; }) + 1) : 0;

                html += '<div class="pt-4 border-t border-white/10"><div class="text-white/80 text-sm font-medium mb-2">我的报名</div>';
                if (myAtt) {
                    if (myAtt.status === 'waitlist') {
                        var myWaitText = '候补中' + (waitIndex ? (' · 第' + waitIndex + '位') : '');
                        html += '<div class="flex items-center justify-between gap-3 py-2"><span class="text-amber-200 text-sm">' + myWaitText + '</span>' +
                            '<button type="button" class="btn btn-danger btn-sm text-xs py-1.5 px-2" id="activityDetailUnregisterBtn" data-activity-id="' + (activity.id || '') + '">取消候补</button></div>';
                    } else {
                        var myStatusText = (myAtt.position && myAtt.position.trim()) ? '已报名 · ' + myAtt.position : '已报名';
                        html += '<div class="flex items-center justify-between gap-3 py-2"><span class="text-white/90 text-sm">' + myStatusText + '</span>' +
                            '<button type="button" class="btn btn-danger btn-sm text-xs py-1.5 px-2" id="activityDetailUnregisterBtn" data-activity-id="' + (activity.id || '') + '">取消报名</button></div>';
                    }
                } else {
                    var isFullNow = regAttendances.length >= totalSlots;
                    html += '<div class="py-2"><button type="button" class="btn btn-primary btn-sm w-full py-1.5 text-sm" id="activityDetailRegisterBtn" data-activity-id="' + (activity.id || '') + '">' + (isFullNow ? '加入候补' : '报名') + '</button></div>';
                }
                html += '</div>';

                var countText = regAttendances.length + '/' + totalSlots + '人' + (waitAttendances.length > 0 ? (' · 候补' + waitAttendances.length) : '');
                html += '<div class="pt-4 border-t border-white/10"><div class="flex items-center justify-between gap-2 mb-2 flex-wrap"><span class="text-white/80 text-sm font-medium">报名名单 <span class="text-white/60 text-sm tabular-nums">' + countText + '</span></span>';
html += (total >= 8) ? ('<a href="/tactics.html?v=20260206-lineup&activityId=' + (activity.id || '') + '" class="btn btn-primary btn-sm shrink-0 font-semibold">阵容</a>') : ('<span class="text-white/50 text-xs">人数上限<8：不展示阵容</span>');
html += '</div>';
                if (regAttendances.length === 0 && waitAttendances.length === 0) {
                    html += '<div class="text-white/50 text-sm">暂无报名</div>';
                } else {
                    if (regAttendances.length > 0) {
                        html += '<div class="text-white/60 text-xs mb-2">已报名</div><ul class="space-y-2">';
                        regAttendances.forEach(function(att) {
                            var statusText = att.status === 'registered' ? '已报名' : (att.status === 'present' ? '到场' : (att.status === 'absent' ? '缺席' : '迟到'));
                            var pos = (att.position != null && String(att.position).trim()) ? String(att.position).trim() : ((att.user && att.user.playingPosition && att.user.playingPosition.trim()) ? att.user.playingPosition.trim() : '未设置');
                            var name = (att.user && att.user.username) ? att.user.username : '—';
                            html += '<li class="flex justify-between items-center text-sm py-2 px-3 rounded-lg bg-white/5">' +
                                '<span class="text-white/90">' + name + '</span>' +
                                '<span class="text-white/60">上场位置：' + pos + ' · ' + statusText + '</span></li>';
                        });
                        html += '</ul>';
                    }
                    if (waitAttendances.length > 0) {
                        html += '<div class="text-white/60 text-xs mt-4 mb-2">候补队列</div><ul class="space-y-2">';
                        waitAttendances.forEach(function(att, idx) {
                            var name = (att.user && att.user.username) ? att.user.username : '—';
                            var pos = (att.user && att.user.playingPosition && att.user.playingPosition.trim()) ? att.user.playingPosition.trim() : '未设置';
                            html += '<li class="flex justify-between items-center text-sm py-2 px-3 rounded-lg bg-white/5">' +
                                '<span class="text-white/90">' + name + '</span>' +
                                '<span class="text-amber-200">候补#' + (idx + 1) + ' · ' + pos + '</span></li>';
                        });
                        html += '</ul>';
                    }
                }
                html += '</div>';
                if (canDeleteActivity(activity)) {
                    html += '<div class="pt-4 border-t border-white/10"><button type="button" class="btn btn-danger w-full" id="activityDetailDeleteBtn" data-activity-id="' + (activity.id || '') + '">删除活动</button></div>';
                }
                content.innerHTML = html;
                var delBtn = document.getElementById('activityDetailDeleteBtn');
                if (delBtn) {
                    delBtn.addEventListener('click', function() {
                        var aid = delBtn.getAttribute('data-activity-id');
                        if (aid) deleteActivity(aid);
                    });
                }
                var regBtn = document.getElementById('activityDetailRegisterBtn');
                if (regBtn) {
                    regBtn.addEventListener('click', function() {
                        var aid = regBtn.getAttribute('data-activity-id');
                        if (aid) openRegisterModal(activity);
                    });
                }
                var unregBtn = document.getElementById('activityDetailUnregisterBtn');
                if (unregBtn) {
                    unregBtn.addEventListener('click', function() {
                        var aid = unregBtn.getAttribute('data-activity-id');
                        if (aid) unregisterActivity(aid);
                    });
                }
                var editNameBtn = document.getElementById('activityDetailEditNameBtn');
                if (editNameBtn) {
                    editNameBtn.addEventListener('click', function() {
                        var aid = editNameBtn.getAttribute('data-activity-id');
                        if (!aid) return;
                        var nameEl = document.getElementById('activityDetailName');
                        var currentName = (activity.name || '未命名').trim();
                        var wrap = nameEl && nameEl.parentElement;
                        if (!wrap) return;
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentName;
                        input.className = 'flex-1 min-w-0 rounded-xl bg-black/30 border border-white/20 px-3 py-2 text-white text-base';
                        input.placeholder = '活动名称';
                        var saveBtn = document.createElement('button');
                        saveBtn.type = 'button';
                        saveBtn.className = 'btn btn-primary btn-sm shrink-0';
                        saveBtn.textContent = '保存';
                        var cancelBtn = document.createElement('button');
                        cancelBtn.type = 'button';
                        cancelBtn.className = 'btn btn-ghost btn-sm shrink-0';
                        cancelBtn.textContent = '取消';
                        var editRow = document.createElement('div');
                        editRow.className = 'flex items-center gap-2 flex-wrap';
                        editRow.appendChild(input);
                        editRow.appendChild(saveBtn);
                        editRow.appendChild(cancelBtn);
                        wrap.innerHTML = '';
                        wrap.appendChild(editRow);
                        input.focus();
                        input.select();
                        saveBtn.onclick = function() {
                            var newName = (input.value || '').trim();
                            if (newName.length < 2) { alert('活动名称至少 2 个字符'); return; }
                            saveBtn.disabled = true;
                            fetch('/activities/' + aid, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                                body: JSON.stringify({ name: newName })
                            }).then(function(r) {
                                if (r.ok) openActivityDetail(aid);
                                else r.json().then(function(err) { alert(err.message || '保存失败'); }).catch(function() { alert('保存失败'); });
                            }).catch(function() { alert('网络错误'); }).finally(function() { saveBtn.disabled = false; });
                        };
                        cancelBtn.onclick = function() { openActivityDetail(aid); };
                    });
                }
                var editVenueBtn = document.getElementById('activityDetailEditVenueBtn');
                if (editVenueBtn) {
                    editVenueBtn.addEventListener('click', function() {
                        var aid = editVenueBtn.getAttribute('data-activity-id');
                        if (!aid) return;
                        var venueEl = document.getElementById('activityDetailVenue');
                        var wrap = venueEl && venueEl.parentElement;
                        if (!wrap) return;
                        var currentVenue = (getVenueDisplay(activity) || '').trim();
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentVenue;
                        input.className = 'flex-1 min-w-0 rounded-xl bg-black/30 border border-white/20 px-3 py-2 text-white text-sm';
                        input.placeholder = '地点';
                        var saveBtn = document.createElement('button');
                        saveBtn.type = 'button';
                        saveBtn.className = 'btn btn-primary btn-sm shrink-0';
                        saveBtn.textContent = '保存';
                        var cancelBtn = document.createElement('button');
                        cancelBtn.type = 'button';
                        cancelBtn.className = 'btn btn-ghost btn-sm shrink-0';
                        cancelBtn.textContent = '取消';
                        var editRow = document.createElement('div');
                        editRow.className = 'flex items-center gap-2 flex-wrap';
                        editRow.appendChild(input);
                        editRow.appendChild(saveBtn);
                        editRow.appendChild(cancelBtn);
                        wrap.innerHTML = '';
                        wrap.appendChild(editRow);
                        input.focus();
                        saveBtn.onclick = function() {
                            var newLocation = (input.value || '').trim();
                            saveBtn.disabled = true;
                            fetch('/activities/' + aid, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                                body: JSON.stringify({ location: newLocation || undefined, venueId: null })
                            }).then(function(r) {
                                if (r.ok) openActivityDetail(aid);
                                else r.json().then(function(err) { alert(err.message || '保存失败'); }).catch(function() { alert('保存失败'); });
                            }).catch(function() { alert('网络错误'); }).finally(function() { saveBtn.disabled = false; });
                        };
                        cancelBtn.onclick = function() { openActivityDetail(aid); };
                    });
                }
                var editDateBtn = document.getElementById('activityDetailEditDateBtn');
                if (editDateBtn) {
                    editDateBtn.addEventListener('click', function() {
                        var aid = editDateBtn.getAttribute('data-activity-id');
                        if (!aid) return;
                        var dateEl = document.getElementById('activityDetailDate');
                        var wrap = dateEl && dateEl.parentElement;
                        if (!wrap) return;
                        var input = document.createElement('input');
                        input.type = 'datetime-local';
                        input.value = formatDateTimeLocal(activity.date);
                        input.className = 'flex-1 min-w-0 rounded-xl bg-black/30 border border-white/20 px-3 py-2 text-white text-sm';
                        var saveBtn = document.createElement('button');
                        saveBtn.type = 'button';
                        saveBtn.className = 'btn btn-primary btn-sm shrink-0';
                        saveBtn.textContent = '保存';
                        var cancelBtn = document.createElement('button');
                        cancelBtn.type = 'button';
                        cancelBtn.className = 'btn btn-ghost btn-sm shrink-0';
                        cancelBtn.textContent = '取消';
                        var editRow = document.createElement('div');
                        editRow.className = 'flex items-center gap-2 flex-wrap';
                        editRow.appendChild(input);
                        editRow.appendChild(saveBtn);
                        editRow.appendChild(cancelBtn);
                        wrap.innerHTML = '';
                        wrap.appendChild(editRow);
                        input.focus();
                        saveBtn.onclick = function() {
                            var dateVal = (input.value || '').trim();
                            if (!dateVal) { alert('请选择时间'); return; }
                            saveBtn.disabled = true;
                            var isoDate = new Date(dateVal).toISOString();
                            fetch('/activities/' + aid, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                                body: JSON.stringify({ date: isoDate })
                            }).then(function(r) {
                                if (r.ok) openActivityDetail(aid);
                                else r.json().then(function(err) { alert(err.message || '保存失败'); }).catch(function() { alert('保存失败'); });
                            }).catch(function() { alert('网络错误'); }).finally(function() { saveBtn.disabled = false; });
                        };
                        cancelBtn.onclick = function() { openActivityDetail(aid); };
                    });
                }
            } catch (err) {
                content.innerHTML = '<div class="text-center py-8 text-red-300 text-sm">网络错误</div>';
            }
        }

        function checkOpenDetailFromUrl() {
            var params = new URLSearchParams(window.location.search);
            var id = params.get('id');
            if (id && id.trim()) {
                window.location.replace('/activity-detail.html?activityId=' + encodeURIComponent(id.trim()));
            }
        }

        (function initActivityPage() {
            var createWrap = document.getElementById('createActivityWrap');
            if (createWrap) createWrap.classList.toggle('hidden', !canCreateActivity());
        })();

        (function setBottomNavActive(){
            var path = window.location.pathname;
            var map = { '/dashboard.html': 'dashboard', '/activities.html': 'activities', '/profile.html': 'me' };
            var key = map[path];
            if (key) document.querySelectorAll('.bottom-nav-item').forEach(function(a) { a.classList.toggle('active', a.dataset.nav === key); });
        })();
        loadActivities();
        checkOpenDetailFromUrl();
    </script>

    <!-- 背景设置模态框 -->
    <div id="backgroundSettingsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">背景设置</h3>
                <button onclick="closeBackgroundSettings()" class="text-white/70 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="backgroundUploadForm" onsubmit="handleBackgroundUpload(event)" class="space-y-4">
                <div>
                    <label class="block text-white/80 mb-2">
                        选择背景图片（最多10张）
                        <span class="text-white/60 text-sm ml-2" id="imageCount">0 / 10</span>
                    </label>
                    <input type="file" id="backgroundImageInput" accept="image/*" multiple onchange="onBackgroundFileChange(event)" 
                        class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-white/20 file:text-white hover:file:bg-white/30">
                    <p class="text-white/60 text-xs mt-1">支持 JPG、PNG、GIF 格式，每张最大 5MB，可多选</p>
                </div>
                
                <!-- 预览区域 -->
                <div id="backgroundPreviewContainer" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto"></div>
                
                <!-- 已上传的图片列表 -->
                <div>
                    <label class="block text-white/80 mb-2">已上传的图片</label>
                    <div id="backgroundImageList" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto p-2 bg-white/5 rounded-lg">
                        <div class="text-center py-8 text-white/60">暂无背景图片，请上传</div>
                    </div>
                </div>

                <!-- 轮播间隔设置 -->
                <div>
                    <label class="block text-white/80 mb-2">
                        轮播间隔
                        <span class="text-white/60 text-sm ml-2" id="intervalDisplay">5 秒</span>
                    </label>
                    <div class="flex space-x-2">
                        <input type="number" id="intervalInput" min="1" max="60" value="5" 
                            class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="button" onclick="setBackgroundInterval()" 
                            class="btn btn-primary">
                            设置
                        </button>
                    </div>
                    <p class="text-white/60 text-xs mt-1">设置背景图片自动切换的间隔时间（秒）</p>
                </div>

                <div id="backgroundError" class="hidden bg-red-500/20 border border-red-500/50 rounded-lg p-3 text-red-200 text-sm"></div>
                <div id="backgroundSuccess" class="hidden bg-green-500/20 border border-green-500/50 rounded-lg p-3 text-green-200 text-sm"></div>
                
                <div class="flex space-x-3">
                    <button type="submit" class="btn btn-primary flex-1">
                        上传图片
                    </button>
                    <button type="button" onclick="resetBackground()" class="btn btn-ghost flex-1">
                        恢复默认
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
      (function(){
      })();
    </script>

    <!-- 引入背景管理器 -->
    <script src="/js/background-manager.js"></script>
</body>
</html>
