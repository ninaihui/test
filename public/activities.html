<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨ç®¡ç† - ä¸šä½™çƒé˜Ÿç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/assets/app.css?v=20260130-1" />
    <style>
        body { margin: 0; min-height: 100vh; color: #e2e8f0; box-sizing: border-box;
            background: linear-gradient(180deg, rgba(0,8,24,.55) 0%, rgba(0,4,16,.72) 100%),
                url('/assets/login-bg.png') no-repeat center center fixed;
            background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; }
        .glass { background: rgba(0,0,0,.18); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255,255,255,.12); }
        .glass input, .glass select, .glass textarea { background: rgba(0,0,0,.28); border: 1px solid rgba(255,255,255,.2); color: #e2e8f0; }
        .activity-list-item { border-bottom: 1px solid rgba(255,255,255,.08); }
        .activity-list-item:last-child { border-bottom: none; }
        /* åˆ›å»ºæ´»åŠ¨å¼¹çª—ï¼šæ‰‹æœºç«¯å›ºå®šé«˜åº¦ï¼Œä¿è¯ä¿å­˜æŒ‰é’®å§‹ç»ˆåœ¨å¯è§†åŒº */
        @media (max-width: 640px) {
            .activity-modal-inner { height: 88vh; max-height: 88vh; }
            .activity-modal-footer {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body class="min-h-screen text-slate-100 safe-bottom pb-24">
    <!-- ä¸»å†…å®¹ï¼šç§»åŠ¨ç«¯ä¼˜å…ˆï¼Œä¸ dashboard ç»Ÿä¸€ -->
    <div class="max-w-2xl mx-auto px-4 py-6">
        <header class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-xl font-bold text-white">æ´»åŠ¨</h1>
                <p class="text-white/60 text-sm">æŠ¥åä¸ç®¡ç†æ´»åŠ¨</p>
            </div>
            <div id="createActivityWrap" class="hidden">
                <button type="button" onclick="showCreateActivityModal()" class="btn btn-primary gap-2 py-3 px-5 shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/30">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    åˆ›å»ºæ´»åŠ¨
                </button>
            </div>
        </header>

        <!-- æ´»åŠ¨åˆ—è¡¨ -->
        <section>
            <h2 class="text-white/80 text-sm font-medium mb-3">æ´»åŠ¨åˆ—è¡¨</h2>
            <div class="glass rounded-2xl overflow-hidden">
                <div id="activitiesList">
                    <div class="text-center py-12 text-white/50 text-sm px-4">
                        <p>æš‚æ— æ´»åŠ¨</p>
                        <p class="mt-2" id="activitiesEmptyHint">åŠ è½½ä¸­â€¦</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
    <nav class="bottom-nav" aria-label="åº•éƒ¨å¯¼èˆª">
        <div class="bottom-nav-inner">
            <a class="bottom-nav-item" data-nav="dashboard" href="/dashboard.html">é¦–é¡µ</a>
            <a class="bottom-nav-item" data-nav="tactics" href="/tactics.html">æˆ˜æœ¯æ¿</a>
            <a class="bottom-nav-item" data-nav="me" href="/profile.html">æˆ‘çš„</a>
        </div>
    </nav>

    <!-- æ´»åŠ¨è¯¦æƒ…å¼¹çª— -->
    <div id="activityDetailModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">æ´»åŠ¨è¯¦æƒ…</h3>
                <button type="button" onclick="closeActivityDetailModal()" class="w-9 h-9 rounded-full flex items-center justify-center text-white/70 hover:text-white bg-white/10 hover:bg-white/20 transition" aria-label="å…³é—­">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div id="activityDetailContent" class="space-y-4">
                <div class="text-center py-8 text-white/50 text-sm">åŠ è½½ä¸­â€¦</div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘æ´»åŠ¨æ¨¡æ€æ¡†ï¼šæ‰‹æœºç«¯å›ºå®šé«˜åº¦+å¯æ»šåŠ¨å†…å®¹ï¼Œä¿å­˜æŒ‰é’®å§‹ç»ˆè´´åº•å¯è§ -->
    <div id="activityModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 safe-area-pb">
        <div class="activity-modal-inner glass rounded-t-2xl sm:rounded-2xl w-full max-w-md flex flex-col shadow-xl sm:max-h-[90vh]">
            <div class="flex justify-between items-center p-4 sm:p-6 pb-2 shrink-0">
                <h3 class="text-xl sm:text-2xl font-bold text-white" id="modalTitle">åˆ›å»ºæ´»åŠ¨</h3>
                <button type="button" onclick="closeActivityModal()" class="w-10 h-10 flex items-center justify-center rounded-full text-white/70 hover:text-white hover:bg-white/10 transition" aria-label="å…³é—­">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="activityForm" class="flex flex-col flex-1 min-h-0 overflow-hidden">
                <div class="overflow-y-auto overflow-x-hidden px-4 sm:p-6 pt-0 space-y-4 flex-1 min-h-0 overscroll-contain">
                    <div>
                        <label class="block text-white/80 mb-2">æ´»åŠ¨æ—¥æœŸ</label>
                        <input type="date" id="activityDate" required 
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">æ´»åŠ¨æ—¶é—´</label>
                        <input type="time" id="activityTime" required 
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">æ´»åŠ¨åœ°ç‚¹</label>
                        <input type="text" id="activityLocation" required placeholder="è¾“å…¥åœºåœ°åç§°æˆ–åœ°å€ï¼Œæˆ–ä»åœ°å›¾é€‰å¥½åç²˜è´´"
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                        <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-1">
                            <a id="activityMapLink" href="https://www.google.com/maps" target="_blank" rel="noopener noreferrer" class="text-sm text-cyan-400/90 hover:underline">åœ¨ Google åœ°å›¾ä¸­é€‰ä½ç½®</a>
                            <span id="activityMapHint" class="text-white/50 text-xs">é€‰å¥½ä½ç½®åï¼Œå°†åœ°å€å¤åˆ¶å›ä¸Šæ–¹è¾“å…¥æ¡†</span>
                        </div>
                        <div class="mt-2 rounded-xl overflow-hidden border border-white/10 bg-black/20" id="activityMapWrap" style="display: none;">
                            <iframe id="activityMapEmbed" title="Google åœ°å›¾" width="100%" height="200" style="border:0;" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white/80 mb-2">æ´»åŠ¨æè¿° <span class="text-white/40 text-sm">ï¼ˆé€‰å¡«ï¼‰</span></label>
                        <textarea id="activityDescription" rows="2" placeholder="å¯é€‰å¤‡æ³¨"
                            class="w-full bg-black/25 border border-white/20 rounded-xl px-4 py-2 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 resize-none"></textarea>
                    </div>
                </div>
                <div class="activity-modal-footer p-4 sm:p-6 pt-4 shrink-0 border-t border-white/10 bg-black/20 sm:bg-transparent sm:border-t-0">
                    <div id="activityError" class="hidden rounded-xl px-4 py-3 text-sm text-red-200 bg-red-500/15 border border-red-500/40 mb-3"></div>
                    <button type="submit" id="activitySubmitBtn" class="btn btn-primary w-full py-3.5 text-base font-semibold gap-2 shadow-lg shadow-cyan-500/25 active:scale-[0.98]">
                        <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç‚«é…·èƒŒæ™¯æ•ˆæœ -->
    <script src="/js/fancy-background.js?v=20260202-1"></script>
    <script>
        const authToken = (localStorage.getItem('authToken') || sessionStorage.getItem('authToken'));
        const LAST_LOCATION_KEY = 'team_management:lastActivityLocation';
        var currentUser = null;
        try {
            var u = localStorage.getItem('user');
            if (u) currentUser = JSON.parse(u);
        } catch (e) {}
        function canCreateActivity() {
            return currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin');
        }
        function canDeleteActivity(activity) {
            return currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin');
        }
        if (!authToken) {
            window.location.href = '/login.html';
        }

        function logout() {
            localStorage.removeItem('authToken'); sessionStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        /** å–å½“å‰å‘¨çš„å‘¨å…­ï¼ˆè‹¥ä»Šå¤©æ˜¯å‘¨å…­åˆ™å–ä»Šå¤©ï¼‰ */
        function getThisWeekSaturday() {
            var d = new Date();
            var day = d.getDay();
            var daysToSat = (6 - day + 7) % 7;
            d.setDate(d.getDate() + daysToSat);
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        function showCreateActivityModal() {
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ´»åŠ¨';
            document.getElementById('activityForm').reset();
            document.getElementById('activityError').classList.add('hidden');
            document.getElementById('activityDate').value = getThisWeekSaturday();
            document.getElementById('activityTime').value = '19:00';
            var locInput = document.getElementById('activityLocation');
            var lastLoc = localStorage.getItem(LAST_LOCATION_KEY);
            if (lastLoc && lastLoc.trim()) {
                locInput.value = lastLoc.trim();
                locInput.dispatchEvent(new Event('input', { bubbles: true }));
            } else {
                document.getElementById('activityMapLink').href = 'https://www.google.com/maps';
                document.getElementById('activityMapLink').textContent = 'åœ¨ Google åœ°å›¾ä¸­é€‰ä½ç½®';
                document.getElementById('activityMapWrap').style.display = 'none';
            }
            document.getElementById('activityModal').classList.remove('hidden');
        }

        document.getElementById('activityLocation').addEventListener('input', function() {
            var loc = this.value.trim();
            var linkEl = document.getElementById('activityMapLink');
            var wrapEl = document.getElementById('activityMapWrap');
            var iframeEl = document.getElementById('activityMapEmbed');
            if (loc) {
                linkEl.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(loc);
                linkEl.textContent = 'åœ¨ Google åœ°å›¾ä¸­æŸ¥çœ‹';
                iframeEl.src = 'https://www.google.com/maps?q=' + encodeURIComponent(loc) + '&output=embed';
                wrapEl.style.display = 'block';
            } else {
                linkEl.href = 'https://www.google.com/maps';
                linkEl.textContent = 'åœ¨ Google åœ°å›¾ä¸­é€‰ä½ç½®';
                wrapEl.style.display = 'none';
                iframeEl.src = '';
            }
        });

        function closeActivityModal() {
            document.getElementById('activityModal').classList.add('hidden');
        }

        document.getElementById('activityForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const errorEl = document.getElementById('activityError');
            const btn = document.getElementById('activitySubmitBtn');
            errorEl.classList.add('hidden');

            const activityDate = document.getElementById('activityDate').value;
            const activityTime = document.getElementById('activityTime').value;
            const location = document.getElementById('activityLocation').value.trim();
            const description = document.getElementById('activityDescription').value.trim() || undefined;

            if (!activityDate || !activityTime || !location) {
                errorEl.textContent = 'è¯·å¡«å†™æ—¥æœŸã€æ—¶é—´å’Œåœ°ç‚¹';
                errorEl.classList.remove('hidden');
                return;
            }

            // æ´»åŠ¨åç§°è‡ªåŠ¨ç”Ÿæˆä¸ºã€Œå‘¨æœ«è¸¢çƒã€
            const name = 'å‘¨æœ«è¸¢çƒ';
            const dateStr = activityDate + 'T' + activityTime + ':00';

            btn.disabled = true;
            try {
                const res = await fetch('/activities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken,
                    },
                    body: JSON.stringify({
                        name,
                        date: dateStr,
                        location: location || undefined,
                        description,
                    }),
                });
                const data = await res.json().catch(() => ({}));
                if (res.ok) {
                    localStorage.setItem(LAST_LOCATION_KEY, location);
                    closeActivityModal();
                    loadActivities();
                } else {
                    errorEl.textContent = data.message || 'åˆ›å»ºå¤±è´¥ï¼ˆ' + res.status + 'ï¼‰';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                errorEl.textContent = err.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        });

        function getVenueDisplay(activity) {
            if (activity.venue && activity.venue.name) return activity.venue.name;
            return activity.location || 'â€”';
        }

        function formatActivityDate(iso) {
            if (!iso) return 'â€”';
            const d = new Date(iso);
            return d.toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        async function loadActivities() {
            const listEl = document.getElementById('activitiesList');
            try {
                const res = await fetch('/activities', {
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                const activities = await res.json();
                const list = Array.isArray(activities) ? activities : [];
                if (list.length === 0) {
                    var emptyHint = canCreateActivity() ? 'ç‚¹å‡»å³ä¸Šè§’ã€Œåˆ›å»ºæ´»åŠ¨ã€å¼€å§‹' : 'è¯·è”ç³»ç®¡ç†å‘˜åˆ›å»ºæ´»åŠ¨';
                    listEl.innerHTML = '<div class="text-center py-12 text-white/50 text-sm px-4"><p>æš‚æ— æ´»åŠ¨</p><p class="mt-2">' + emptyHint + '</p></div>';
                    return;
                }
                listEl.innerHTML = list.map(function(a) {
                    var venueDisplay = getVenueDisplay(a);
                    var canDel = canDeleteActivity(a);
                    var row = '<div class="activity-list-item flex justify-between items-center gap-2 py-4 px-4 hover:bg-white/5 transition">' +
                        '<a href="/activities.html?id=' + (a.id || '') + '" class="min-w-0 flex-1 flex items-center gap-4">' +
                        '<div class="min-w-0 flex-1"><div class="text-white font-medium">' + (a.name || 'æœªå‘½å') + '</div>' +
                        '<div class="text-white/60 text-sm mt-0.5">' + venueDisplay + ' Â· ' + formatActivityDate(a.date) + '</div></div>' +
                        '<span class="text-white/40 text-sm shrink-0">æŸ¥çœ‹ â†’</span></a>';
                    if (canDel) {
                        row += '<button type="button" class="btn btn-danger btn-sm shrink-0" data-activity-id="' + (a.id || '') + '" aria-label="åˆ é™¤æ´»åŠ¨">åˆ é™¤</button>';
                    }
                    row += '</div>';
                    return row;
                }).join('');
                listEl.querySelectorAll('[data-activity-id]').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var id = btn.getAttribute('data-activity-id');
                        if (id) deleteActivity(id);
                    });
                });
            } catch (err) {
                listEl.innerHTML = '<div class="text-center py-12 text-red-300 text-sm">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        function closeActivityDetailModal() {
            document.getElementById('activityDetailModal').classList.add('hidden');
            if (window.history && window.history.replaceState) {
                var url = new URL(window.location.href);
                url.searchParams.delete('id');
                window.history.replaceState({}, '', url.pathname + (url.search || ''));
            }
        }

        async function deleteActivity(id) {
            if (!id || !confirm('ç¡®å®šåˆ é™¤è¯¥æ´»åŠ¨ï¼Ÿåˆ é™¤åæŠ¥åè®°å½•ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚')) return;
            try {
                var res = await fetch('/activities/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.ok) {
                    closeActivityDetailModal();
                    loadActivities();
                } else {
                    var err = await res.json().catch(function() { return {}; });
                    alert(err.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        async function registerActivity(id) {
            if (!id) return;
            try {
                var res = await fetch('/activities/' + id + '/register', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.ok) openActivityDetail(id);
                else {
                    var err = await res.json().catch(function() { return {}; });
                    alert(err.message || 'æŠ¥åå¤±è´¥');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        async function unregisterActivity(id) {
            if (!id || !confirm('ç¡®å®šå–æ¶ˆæŠ¥åï¼Ÿ')) return;
            try {
                var res = await fetch('/activities/' + id + '/register', {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + authToken },
                });
                if (res.ok) openActivityDetail(id);
                else {
                    var err = await res.json().catch(function() { return {}; });
                    alert(err.message || 'å–æ¶ˆå¤±è´¥');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        async function openActivityDetail(id) {
            var modal = document.getElementById('activityDetailModal');
            var content = document.getElementById('activityDetailContent');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="text-center py-8 text-white/50 text-sm">åŠ è½½ä¸­â€¦</div>';
            try {
                var res = await fetch('/activities/' + id, { headers: { 'Authorization': 'Bearer ' + authToken } });
                if (!res.ok) {
                    content.innerHTML = '<div class="text-center py-8 text-red-300 text-sm">åŠ è½½å¤±è´¥</div>';
                    return;
                }
                var activity = await res.json();
                var venueDisplay = getVenueDisplay(activity);
                var canEdit = canDeleteActivity(activity);
                var displayName = (activity.name || 'æœªå‘½å').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                var titleHtml = canEdit
                    ? '<div class="flex items-center justify-between gap-2 flex-wrap"><span class="text-white font-semibold text-lg" id="activityDetailName">' + displayName + '</span><button type="button" class="btn btn-ghost btn-sm shrink-0" id="activityDetailEditNameBtn" data-activity-id="' + (activity.id || '') + '">ç¼–è¾‘åç§°</button></div>'
                    : '<div class="text-white font-semibold text-lg" id="activityDetailName">' + displayName + '</div>';
                var html = titleHtml +
                    '<div class="text-white/70 text-sm">' + (venueDisplay || 'â€”').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') + '</div>' +
                    '<div class="text-white/60 text-sm">' + formatActivityDate(activity.date) + '</div>';
                if (venueDisplay && venueDisplay !== 'â€”') {
                    var mapQuery = encodeURIComponent(venueDisplay);
                    var navUrl = 'https://www.google.com/maps/dir/?api=1&destination=' + mapQuery;
                    var venueEscaped = (venueDisplay || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    html += '<div class="pt-3"><div class="text-white/70 text-sm mb-2">åœ°ç‚¹ï¼š' + venueEscaped + '</div><a href="' + navUrl + '" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 py-2 px-3 rounded-xl bg-white/10 border border-white/15 text-cyan-400/90 hover:bg-white/15 hover:text-cyan-400 text-sm font-medium transition">ğŸ“ å®šä½ Â· ç‚¹å‡»å¯¼èˆªè‡³æ­¤å¤„</a></div>';
                }
                if (activity.description && activity.description.trim()) {
                    html += '<div class="text-white/60 text-sm pt-2 border-t border-white/10">' + activity.description.trim() + '</div>';
                }
                var attendances = activity.attendances || [];
                var myAtt = currentUser ? (attendances.find(function(a) { return a.user && a.user.id === currentUser.id; }) || null) : null;
                html += '<div class="pt-4 border-t border-white/10"><div class="text-white/80 text-sm font-medium mb-2">æˆ‘çš„æŠ¥å</div>';
                if (myAtt) {
                    var myStatusText = (myAtt.position && myAtt.position.trim()) ? 'å·²æŠ¥å Â· ' + myAtt.position : 'å·²æŠ¥å';
                    html += '<div class="flex items-center justify-between gap-3 py-2"><span class="text-white/90 text-sm">' + myStatusText + '</span>' +
                        '<button type="button" class="btn btn-ghost btn-sm" id="activityDetailUnregisterBtn" data-activity-id="' + (activity.id || '') + '">å–æ¶ˆæŠ¥å</button></div>';
                } else {
                    html += '<div class="py-2"><button type="button" class="btn btn-primary w-full py-2" id="activityDetailRegisterBtn" data-activity-id="' + (activity.id || '') + '">æŠ¥å</button></div>';
                }
                html += '</div>';
                html += '<div class="pt-4 border-t border-white/10"><div class="text-white/80 text-sm font-medium mb-2">æŠ¥ååå•</div>';
                if (attendances.length === 0) {
                    html += '<div class="text-white/50 text-sm">æš‚æ— æŠ¥å</div>';
                } else {
                    html += '<ul class="space-y-2">';
                    attendances.forEach(function(att) {
                        var statusText = att.status === 'registered' ? 'å·²æŠ¥å' : (att.status === 'present' ? 'åˆ°åœº' : (att.status === 'absent' ? 'ç¼ºå¸­' : 'è¿Ÿåˆ°'));
                        var pos = (att.position && att.position.trim()) ? att.position : '';
                        html += '<li class="flex justify-between items-center text-sm py-2 px-3 rounded-lg bg-white/5">' +
                            '<span class="text-white/90">' + (att.user && att.user.username ? att.user.username : 'â€”') + '</span>' +
                            '<span class="text-white/60">' + statusText + (pos ? ' Â· ' + pos : '') + '</span></li>';
                    });
                    html += '</ul>';
                }
                html += '</div>';
                if (canDeleteActivity(activity)) {
                    html += '<div class="pt-4 border-t border-white/10"><button type="button" class="btn btn-danger w-full" id="activityDetailDeleteBtn" data-activity-id="' + (activity.id || '') + '">åˆ é™¤æ´»åŠ¨</button></div>';
                }
                content.innerHTML = html;
                var delBtn = document.getElementById('activityDetailDeleteBtn');
                if (delBtn) {
                    delBtn.addEventListener('click', function() {
                        var aid = delBtn.getAttribute('data-activity-id');
                        if (aid) deleteActivity(aid);
                    });
                }
                var regBtn = document.getElementById('activityDetailRegisterBtn');
                if (regBtn) {
                    regBtn.addEventListener('click', function() {
                        var aid = regBtn.getAttribute('data-activity-id');
                        if (aid) registerActivity(aid);
                    });
                }
                var unregBtn = document.getElementById('activityDetailUnregisterBtn');
                if (unregBtn) {
                    unregBtn.addEventListener('click', function() {
                        var aid = unregBtn.getAttribute('data-activity-id');
                        if (aid) unregisterActivity(aid);
                    });
                }
                var editNameBtn = document.getElementById('activityDetailEditNameBtn');
                if (editNameBtn) {
                    editNameBtn.addEventListener('click', function() {
                        var aid = editNameBtn.getAttribute('data-activity-id');
                        if (!aid) return;
                        var nameEl = document.getElementById('activityDetailName');
                        var currentName = (activity.name || 'æœªå‘½å').trim();
                        var wrap = nameEl && nameEl.parentElement;
                        if (!wrap) return;
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentName;
                        input.className = 'flex-1 min-w-0 rounded-xl bg-black/30 border border-white/20 px-3 py-2 text-white text-base';
                        input.placeholder = 'æ´»åŠ¨åç§°';
                        var saveBtn = document.createElement('button');
                        saveBtn.type = 'button';
                        saveBtn.className = 'btn btn-primary btn-sm shrink-0';
                        saveBtn.textContent = 'ä¿å­˜';
                        var cancelBtn = document.createElement('button');
                        cancelBtn.type = 'button';
                        cancelBtn.className = 'btn btn-ghost btn-sm shrink-0';
                        cancelBtn.textContent = 'å–æ¶ˆ';
                        var editRow = document.createElement('div');
                        editRow.className = 'flex items-center gap-2 flex-wrap';
                        editRow.appendChild(input);
                        editRow.appendChild(saveBtn);
                        editRow.appendChild(cancelBtn);
                        wrap.innerHTML = '';
                        wrap.appendChild(editRow);
                        input.focus();
                        input.select();
                        saveBtn.onclick = function() {
                            var newName = (input.value || '').trim();
                            if (newName.length < 2) { alert('æ´»åŠ¨åç§°è‡³å°‘ 2 ä¸ªå­—ç¬¦'); return; }
                            saveBtn.disabled = true;
                            fetch('/activities/' + aid, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                                body: JSON.stringify({ name: newName })
                            }).then(function(r) {
                                if (r.ok) openActivityDetail(aid);
                                else r.json().then(function(err) { alert(err.message || 'ä¿å­˜å¤±è´¥'); }).catch(function() { alert('ä¿å­˜å¤±è´¥'); });
                            }).catch(function() { alert('ç½‘ç»œé”™è¯¯'); }).finally(function() { saveBtn.disabled = false; });
                        };
                        cancelBtn.onclick = function() { openActivityDetail(aid); };
                    });
                }
            } catch (err) {
                content.innerHTML = '<div class="text-center py-8 text-red-300 text-sm">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        function checkOpenDetailFromUrl() {
            var params = new URLSearchParams(window.location.search);
            var id = params.get('id');
            if (id && id.trim()) {
                openActivityDetail(id.trim());
            }
        }

        (function initActivityPage() {
            var createWrap = document.getElementById('createActivityWrap');
            if (createWrap) createWrap.classList.toggle('hidden', !canCreateActivity());
        })();

        (function setBottomNavActive(){
            var path = window.location.pathname;
            var map = { '/dashboard.html': 'dashboard', '/tactics.html': 'tactics', '/profile.html': 'me' };
            var key = map[path];
            if (key) document.querySelectorAll('.bottom-nav-item').forEach(function(a) { a.classList.toggle('active', a.dataset.nav === key); });
        })();
        loadActivities();
        checkOpenDetailFromUrl();
    </script>

    <!-- èƒŒæ™¯è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="backgroundSettingsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">èƒŒæ™¯è®¾ç½®</h3>
                <button onclick="closeBackgroundSettings()" class="text-white/70 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="backgroundUploadForm" onsubmit="handleBackgroundUpload(event)" class="space-y-4">
                <div>
                    <label class="block text-white/80 mb-2">
                        é€‰æ‹©èƒŒæ™¯å›¾ç‰‡ï¼ˆæœ€å¤š10å¼ ï¼‰
                        <span class="text-white/60 text-sm ml-2" id="imageCount">0 / 10</span>
                    </label>
                    <input type="file" id="backgroundImageInput" accept="image/*" multiple onchange="onBackgroundFileChange(event)" 
                        class="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-white/20 file:text-white hover:file:bg-white/30">
                    <p class="text-white/60 text-xs mt-1">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæ¯å¼ æœ€å¤§ 5MBï¼Œå¯å¤šé€‰</p>
                </div>
                
                <!-- é¢„è§ˆåŒºåŸŸ -->
                <div id="backgroundPreviewContainer" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto"></div>
                
                <!-- å·²ä¸Šä¼ çš„å›¾ç‰‡åˆ—è¡¨ -->
                <div>
                    <label class="block text-white/80 mb-2">å·²ä¸Šä¼ çš„å›¾ç‰‡</label>
                    <div id="backgroundImageList" class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto p-2 bg-white/5 rounded-lg">
                        <div class="text-center py-8 text-white/60">æš‚æ— èƒŒæ™¯å›¾ç‰‡ï¼Œè¯·ä¸Šä¼ </div>
                    </div>
                </div>

                <!-- è½®æ’­é—´éš”è®¾ç½® -->
                <div>
                    <label class="block text-white/80 mb-2">
                        è½®æ’­é—´éš”
                        <span class="text-white/60 text-sm ml-2" id="intervalDisplay">5 ç§’</span>
                    </label>
                    <div class="flex space-x-2">
                        <input type="number" id="intervalInput" min="1" max="60" value="5" 
                            class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="button" onclick="setBackgroundInterval()" 
                            class="btn btn-primary">
                            è®¾ç½®
                        </button>
                    </div>
                    <p class="text-white/60 text-xs mt-1">è®¾ç½®èƒŒæ™¯å›¾ç‰‡è‡ªåŠ¨åˆ‡æ¢çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰</p>
                </div>

                <div id="backgroundError" class="hidden bg-red-500/20 border border-red-500/50 rounded-lg p-3 text-red-200 text-sm"></div>
                <div id="backgroundSuccess" class="hidden bg-green-500/20 border border-green-500/50 rounded-lg p-3 text-green-200 text-sm"></div>
                
                <div class="flex space-x-3">
                    <button type="submit" class="btn btn-primary flex-1">
                        ä¸Šä¼ å›¾ç‰‡
                    </button>
                    <button type="button" onclick="resetBackground()" class="btn btn-ghost flex-1">
                        æ¢å¤é»˜è®¤
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
      (function(){
      })();
    </script>

    <!-- å¼•å…¥èƒŒæ™¯ç®¡ç†å™¨ -->
    <script src="/js/background-manager.js?v=20260202-1"></script>
</body>
</html>
