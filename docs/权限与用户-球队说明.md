# 权限与用户-球队说明

## 一、怎么知道哪个用户是哪个队伍的？

### 1. 数据关系

- **用户 ↔ 球队** 是多对多，通过中间表 **`team_members`** 关联：
  - `userId`：用户 ID
  - `teamId`：球队 ID
  - `role`：在该队内的角色（member / captain / coach）
  - `number`：球衣号码（由球队管理员分配）
- 每个球队还可以有一个 **球队管理员**：`teams.adminUserId`，负责分配号码、转移管理员等。

所以：
- **某用户属于哪些队**：查 `team_members` 里 `userId = 该用户` 的记录，对应的 `teamId` 就是其加入的球队。
- **某队有哪些人**：查 `team_members` 里 `teamId = 该队` 的记录，对应的 `userId` 就是成员。

### 2. 通过接口怎么查

| 需求 | 接口 | 说明 |
|------|------|------|
| 当前登录用户加入了哪些队 | `GET /teams` | 返回该用户作为成员的所有球队（含成员数、活动数等） |
| 某个队的详情（含成员列表） | `GET /teams/:id` | 需要是该队成员；返回球队信息 + members（含 user 信息） |
| 某个队的名单（战术板/号码） | `GET /teams/:id/roster` | 需要是该队成员；返回成员列表（含 user、number 等） |

- **“用户 A 是哪个队的”**：用当前用户登录后调 `GET /teams` 得到的是“我”的球队；要查**任意用户**属于哪些队，需要后台按 `userId` 查 `team_members`（目前需在数据库或后续加管理端接口）。

### 3. 在数据库里直接查

```sql
-- 某用户加入了哪些队（把 '用户ID' 换成实际 userId）
SELECT t.id, t.name, tm.role, tm.number
FROM team_members tm
JOIN teams t ON t.id = tm.team_id
WHERE tm.user_id = '用户ID';

-- 某队有哪些成员（把 '球队ID' 换成实际 teamId）
SELECT u.id, u.username, u.email, tm.role, tm.number
FROM team_members tm
JOIN users u ON u.id = tm.user_id
WHERE tm.team_id = '球队ID';
```

---

## 二、现在都有什么权限的用户？

权限分两层：**系统级角色** 和 **球队内角色**。

### 1. 系统级角色（`users.role`）

在 **用户表** 的 `role` 字段，表示整站权限：

| 角色 | 说明 | 典型权限 |
|------|------|----------|
| **user** | 普通用户 | 注册、登录、管理自己的球队/活动/考勤，加入球队等 |
| **admin** | 管理员 | 在 user 基础上，可调用 `POST /auth/create-user` 创建普通用户 |
| **super_admin** | 超级管理员 | 可调用 `POST /auth/create-admin` 创建管理员；代码里与 admin 一起可创建普通用户 |

说明：
- 注册接口 `POST /auth/register` 创建的都是 `user`。
- `admin` 需要由已有 **super_admin** 通过 `POST /auth/create-admin` 创建（或直接在数据库把某用户的 `role` 改为 `admin`）。
- `super_admin` 目前需在数据库手动设置（例如把第一个用户的 `role` 改为 `super_admin`）。

### 2. 球队内角色（`team_members.role`）

在 **球队成员表** 的 `role` 字段，只在该队内有效：

| 角色 | 说明 |
|------|------|
| **member** | 普通队员 |
| **captain** | 队长：可更新球队信息、删除球队、添加/移除成员等 |
| **coach** | 教练：可更新球队信息、添加/移除成员（不能删除球队） |

### 3. 球队管理员（`teams.admin_user_id`）

- 每个球队**一个**管理员，存在 `teams.admin_user_id`。
- 创建球队时，创建者会自动成为该队的 **球队管理员**。
- 球队管理员可：
  - 给成员分配/修改球衣号码（`PATCH /teams/:id/members/:memberId/number`）
  - 转移球队管理员给其他人（`PATCH /teams/:id/admin`）
- 与系统角色无关：一个 `user` 可以是某队的球队管理员；`admin` / `super_admin` 也可以只是某队的普通成员。

### 4. 接口权限小结

| 接口 | 所需权限 |
|------|----------|
| `POST /auth/register` | 无（公开） |
| `POST /auth/create-admin` | 仅 **super_admin** |
| `POST /auth/create-user` | **admin** 或 **super_admin** |
| `GET /teams`、`GET /teams/:id`、`GET /teams/:id/roster` 等 | 已登录 + 若是某队相关则需为该队成员 |
| 更新/删除球队、增删成员 | 已登录 + 该队 **captain** 或 **coach**（删队仅 captain） |
| 分配号码、转移球队管理员 | 已登录 + 该队 **球队管理员**（即 `teams.admin_user_id`） |

---

## 三. 如何快速得到一个 super_admin？

目前没有接口可以“注册成 super_admin”，需要在数据库里把某个用户改成超级管理员，例如：

```sql
UPDATE users SET role = 'super_admin' WHERE email = '你的邮箱@example.com';
-- 或按用户名
UPDATE users SET role = 'super_admin' WHERE username = '你的用户名';
```

之后用该账号登录，即可调用 `POST /auth/create-admin` 创建管理员账户。
